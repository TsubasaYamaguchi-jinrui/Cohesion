# メスの被攻撃頻度はどのようなときに多くなるか  
以下では、メスがオスから攻撃される頻度がどのような要因によって変化するのかを検討する。  

## 個体追跡データによる分析  
### データの加工  
個体追跡の生データを加工する。メスの被攻撃頻度に関連する要因としては、以下のものを考える。2018年は群れ外オス数が確認できていないため、ここでは除外する。また、60分以上追跡できた個体追跡セッションのみを用いる。      

- 追跡個体の発情の有無  
- 観察日の群れ外オス数  
- 観察日の発情メス数  
- 観察時の*TY*の有無、*IT*の有無(2019~2020年のみ)   

**群れオス・群れ外オスを区別せず**  
```{r}
focal_raw_fin %>% 
  group_by(no_focal, subject, rs2, TY, IT) %>% 
  summarise(no_agg1 = sum(if_victim1, na.rm = TRUE),
            no_agg2 = sum(if_victim2, na.rm = TRUE),
            dur = max(time),
            no_ntm = mean(no_ntm, na.rm = TRUE),
            no_est = mean(no_est, na.rm = TRUE),
            study_period = unique(study_period)) %>% 
  ungroup() %>% 
  mutate(no_agg = no_agg1 + no_agg2) %>% 
  select(-no_agg1, -no_agg2) %>% 
  mutate(logdur = log(dur/60)) %>% 
  replace_na(list(IT = 0)) %>% 
  mutate(cen_ntm = no_ntm - mean(no_ntm, na.rm = TRUE),
         cen_est = no_est - mean(no_est, na.rm = TRUE),
         std_ntm = standardize(no_ntm),
         std_est = standardize(no_est)) -> focal_sum
```


**群れオス・群れ外オスを区別**  
```{r}
focal_raw_fin %>% 
  left_join(males, by = c("study_period", "aggressor_focal1" = "maleID")) %>% 
  rename(ntm1 = ntm) %>% 
  mutate(ntm1 = ifelse(is.na(aggressor_focal1),NA,
                       ifelse(is.na(ntm1) & !is.na(aggressor_focal1),1,ntm1))) %>% 
  left_join(males, by = c("study_period", "aggressor_focal2" = "maleID")) %>% 
  rename(ntm2 = ntm) %>% 
  mutate(ntm2 = ifelse(is.na(aggressor_focal2),NA,
                       ifelse(is.na(ntm2) & !is.na(aggressor_focal2),1,ntm1))) -> focal_raw_fin_b
  
focal_raw_fin_b %>% 
  filter(agg_focal == "1") %>% 
  group_by(no_focal, subject, ntm1) %>% 
  summarise(no_agg = sum(agg_focal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = ntm1, values_from = no_agg) %>% 
  rename(agg_tm1 = `0`, agg_ntm1 = `1`) %>% 
  replace_na(list(agg_tm1 = 0, agg_ntm1 = 0))-> focal_list_ntm1

focal_raw_fin_b %>% 
  filter(agg_focal == "1" & !is.na(aggressor_focal2)) %>% 
  group_by(no_focal, subject, ntm2) %>% 
  summarise(no_agg = sum(agg_focal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  pivot_wider(names_from = ntm2, values_from = no_agg) %>% 
  rename(agg_tm2 = `0`, agg_ntm2 = `1`) %>% 
  replace_na(list(agg_tm2 = 0, agg_ntm2 = 0)) -> focal_list_ntm2

left_join(focal_list_ntm1, focal_list_ntm2) %>% 
  replace_na(list(agg_tm2 = 0, agg_ntm2 = 0)) %>% 
  mutate(agg_tm = agg_tm1 + agg_tm2,
         agg_ntm = agg_ntm1 + agg_ntm2) %>% 
  select(-(agg_tm1:agg_ntm2)) %>% 
  right_join(focal_sum) %>% 
  replace_na(list(agg_tm = 0, agg_ntm = 0)) -> focal_sum_ntm
```

まとめたものは以下の通り。  
```{r}
datatable(focal_sum,
          options = list(scrollX = 10),
          filter = list(position ="top"))
```
<br/>  


### データの分布の確認  
#### 攻撃するオスのID  

#### 調査年ごとの被攻撃頻度  
調査期間ごとに、発情メス・非発情メスが群れオス・群れ外オスから攻撃された頻度を図示する。  
```{r}
focal_sum_ntm %>% 
  filter(dur >= 60) %>% 
  pivot_longer(agg_tm:agg_ntm, names_to = "type", values_to= "agg") %>% 
  ggplot(aes(x = study_period, y = agg*60/dur))+
  geom_violin(aes(fill = type), bw = 0.25,
              color = "black")+
  geom_boxplot(aes(color = type),
               fill = "grey85",
               outlier.alpha = 0,
               width = 0.1,
               position = position_dodge(0.9))+
  stat_summary(aes(fill = type),
               fun = "mean",
               position = position_dodge(0.9),
               shape = 18,
               size = 0.75)+
  labs(x = "", y = "被\n攻\n撃\n頻\n度\n(回/h)",
       fill = "", color = "")+
  facet_rep_wrap(~rs2, repeat.tick.labels = TRUE,
                 ncol = 2,
                 labeller = as_labeller(c("0" = "非発情メス","1" = "発情メス")))+
  theme_bw(base_size = 15)+
  scale_fill_manual(values = c("grey54","white"),
                    labels = c("群れ外オス","群れオス"))+
  scale_color_manual(values = c("grey83","grey83"),
                    labels = c("群れ外オス","群れオス"))+
  scale_x_discrete(labels = c("2018年","2019年","2020年","2021年"))+
  theme(aspect.ratio = 0.7,
        strip.background = element_blank(),
        strip.text = element_text(family = "Yu Mincho",
                                  hjust = 0),
        axis.text.x =  element_text(family = "Yu Mincho"),
        axis.title.y = element_text(family = "Yu Mincho",
                                    angle = 0,
                                    vjust = 0.5),
        legend.text = element_text(family = "Yu Mincho"),
        axis.text.y = element_text(family = "Times New Roman")) -> p_agg_studyperiod

# ggsave("figure/p_agg_studyperiod.png", p_agg_studyperiod, width = 270, height = 110, units = "mm", dpi = 600)
```

以下の通り。  
```{r fig-aggcomp, echo=FALSE, out.width="60%", fig.cap="調査期間ごとの被攻撃頻度"}
knitr::include_graphics("figure/p_agg_studyperiod.png")
```
<br/>  

```{r}
focal_sum_ntm %>% 
  filter(study_period != "m18") %>% 
  filter(dur >= 60) %>% 
  pivot_longer(agg_tm:agg_ntm, names_to = "type", values_to= "agg") %>% 
  ggplot(aes(x = no_ntm, y = agg*60/dur))+
  geom_count()+
  facet_grid(rs2~study_period,
             scales = "free")
```

### 分析  
#### 群れオスと群れ外オスの攻撃を区別しない    
まず、群れオスと群れ外オスの攻撃を区別しないで分析を行う。  

##### モデリング    
モデルの詳細は以下の通り。なお、群れ外オス数と発情メス数は中心化した。    

- 分布: 負の二項分布  
- 応答変数: 被攻撃回数(`no_agg`)    
- オフセット項: log(追跡時間)(`logdur`)    
- 説明変数: 追跡個体の発情の有無(`rs2`)、観察日の群れ外オス数(`cen_ntm`)、発情メス数(`cen_est`)、発情の有無×群れ外オス数、発情の有無×発情メス数、*TY*の有無(`TY`)、調査期間(`study_period`)    
- ランダム切片: 追跡個体ID  

```{r}
m_aggfocal <- brm(no_agg ~ cen_ntm  + cen_est + rs2 + cen_ntm:rs2 + cen_est:rs2 + TY + study_period 
                  + offset(logdur) + (1|subject),
                     family = negbinomial,
                     iter = 5000, warmup = 2500, seed = 13,
                     prior = c(prior(student_t(4,0,5), class = "b"),
                           prior(student_t(4,0,10), class = "Intercept"),
                           prior(student_t(4,0,10), class = "sd"),
                           prior(gamma(0.01,0.01), class = "shape")),
                     control=list(adapt_delta = 0.9999, max_treedepth = 20),
                     backend = "cmdstanr",
                     data = focal_sum,
                  file = "model/m_aggfocal.rds")
```

###### モデルチェック  
分布から大きく外れていることはなく、過分散や外れ値の問題もないよう。  
```{r, include = FALSE}
check_m_aggfocal <- dh_check_brms(m_aggfocal)
```

```{r}
plotQQunif(check_m_aggfocal)
```

ゼロ過剰の問題もない。  
```{r}
testZeroInflation(check_m_aggfocal)
```

VIFは全て10以下であり、そこまで多重共線性の問題はないよう。  
```{r}
check_collinearity(m_aggfocal)
```

###### 結果の確認  
発情メス数と*TY*の有無、発情の有無、調査期間が有意な影響。*TY*の有無については、*TY*がいる日は被攻撃頻度が有意に低下する。また、2021年は他の変数を統制したときに2019年より被攻撃頻度が低かったようだ。  
```{r}
model_parameters(m_aggfocal)
```
<br/>  

交互作用項のある変数の検討を行う。  

まず、発情メス数については発情メス・非発情メスのいずれについても被攻撃頻度と正の関連があった。  
```{r}
estimate_slopes(m_aggfocal,
               trend = "cen_est",
               at = "rs2 = c(0,1)")
```
<br/>  

群れ外オス数については、発情の有無に限らず被攻撃頻度とは有意な関連がなかった。  
```{r}
estimate_slopes(m_aggfocal,
               trend = "cen_ntm",
               at = "rs2 = c(0,1)")
```
<br/>  

発情の有無については、群れ外オス数に関わりなく非発情メスの方が発情メスよりも被攻撃頻度が有意に低い(図\@ref(fig:fig-aggfocal-rs)の左)。一方で、発情メス数との関連については、発情メス数が10頭を超えるくらいまでは非発情メスの方が発情メスよりも被攻撃頻度が有意に低い(図\@ref(fig:fig-aggfocal-rs)の右)。10頭を超えることはまれなので、ほとんどの場合において非発情メスの方が被攻撃頻度は低いといえるだろう。  

```{r fig-aggfocal-rs, fig.dim = c(12,5), fig.cap = "群れ外オス数/発情メス数ごとの発情の有無の効果"}
estimate_contrasts(m_aggfocal,
                   contrast = "rs2 = c(0,1)",
                   at = c("cen_ntm"),
                   length = 30) %>% 
  data.frame() -> estimate_cont_rs_ntm

estimate_cont_rs_ntm %>%
  mutate(no_ntm = cen_ntm + mean(focal_sum$no_ntm)) %>% 
  ggplot(aes(x = no_ntm, y = Difference))+
  geom_line()+
  geom_ribbon(aes(ymin = CI_low,
                  ymax = CI_high),
              alpha = 0.2)+
  geom_hline(yintercept = 0,
             color = "red")+
  theme_bw(base_size = 14)+
  theme(aspect.ratio = 1,
        plot.title = element_text(size = 13))+
  scale_x_continuous(breaks = seq(0,13,1))+
  labs(title = "Effect of estrous status\nby number of nontroop males",
       y = "anesrus - estrous",
       x = "no. of nontroop males") -> p_cont_rs_ntm

estimate_contrasts(m_aggfocal,
                   contrast = "rs2 = c(0,1)",
                   at = c("cen_est"),
                   length = 30) %>% 
  data.frame() -> estimate_cont_rs_est

estimate_cont_rs_est %>%
  mutate(no_est = cen_est + mean(focal_sum$no_est)) %>% 
  ggplot(aes(x = no_est, y = Difference))+
  geom_line()+
  geom_ribbon(aes(ymin = CI_low,
                  ymax = CI_high),
              alpha = 0.2)+
  geom_hline(yintercept = 0,
             color = "red")+
  theme_bw(base_size = 14)+
  theme(aspect.ratio = 1,
        plot.title = element_text(size = 13))+
  scale_x_continuous(breaks = seq(0,13,1))+
  labs(title = "Effect of estrous status\nby number of estrous females",
       y = "anesrus - estrous",
       x = "no. of estrous females") -> p_cont_rs_est

p_cont_rs_ntm + p_cont_rs_est
```

###### 結果の図示  

##### 結果まとめ  
- *TY*が群れにいる日はいない日に比べて、また(発情メス数が10頭以下くらいであれば)非発情メスは発情メスに比べて被攻撃頻度が有意に低かった。  
- 発情メス・非発情メスいずれについても発情メス数が多い日ほど被攻撃頻度が高い傾向があった。  


#### 群れオス・群れ外オスを区別  
続いて、群れオスと群れ外オスの攻撃を区別して分析する。  
いずれの分析ではモデルは以下の通りで、群れオス・群れ外オスを区別しない場合と同じである。  

- 分布: 負の二項分布  
- 応答変数: 被攻撃回数(`no_agg`)    
- オフセット項: log(追跡時間)(`logdur`)    
- 説明変数: 追跡個体の発情の有無(`rs2`)、観察日の群れ外オス数(`cen_ntm`)、発情メス数(`cen_est`)、発情の有無×群れ外オス数、発情の有無×発情メス数、*TY*の有無(`TY`)、調査期間(`study_period`)    
- ランダム切片: 追跡個体ID  

##### 群れオスからの攻撃頻度  
###### モデリング1    
まず、群れオスの攻撃についてモデリングする。  
```{r}
m_aggfocal_tm <- brm(agg_tm ~ cen_est + cen_ntm  +  rs2 +  cen_est:rs2 +  cen_ntm:rs2 + TY + IT + study_period 
                         + offset(logdur) + (1|subject),
                         family = negbinomial,
                         iter = 5000, warmup = 2500, seed = 13,
                           prior = c(prior(student_t(4,0,5), class = "b"),
                           prior(student_t(4,0,10), class = "Intercept"),
                           prior(student_t(4,0,10), class = "sd"),
                           prior(gamma(0.01,0.01), class = "shape")),
                         control=list(adapt_delta = 0.9999, max_treedepth = 20),
                         backend = "cmdstanr",
                         data = focal_sum_ntm,
                         file = "model/m_aggfocal_tm.rds")
```

**モデルチェック**  
分布から大きく外れていることはなく、過分散や外れ値の問題もないよう。  
```{r, include = FALSE}
check_m_aggfocal_tm <- dh_check_brms(m_aggfocal_tm)
```

```{r}
plotQQunif(check_m_aggfocal_tm)
```

ゼロ過剰の問題もない。  
```{r}
testZeroInflation(check_m_aggfocal_tm)
```

ただし、VIFが10以上の変数がある。  
```{r}
check_collinearity(m_aggfocal_tm)
```

###### モデリング2      
そこで、以下で群れ外オス数と発情メス数についてそれぞれ別のモデルを作成した。 
```{r}
m_aggfocal_tm_est <- brm(agg_tm ~ cen_est  +  rs2 +  cen_est:rs2 + TY + study_period 
                         + offset(logdur) + (1|subject),
                         family = negbinomial,
                         iter = 5000, warmup = 2500, seed = 13,
                           prior = c(prior(student_t(4,0,5), class = "b"),
                           prior(student_t(4,0,10), class = "Intercept"),
                           prior(student_t(4,0,10), class = "sd"),
                           prior(gamma(0.01,0.01), class = "shape")),
                         control=list(adapt_delta = 0.9999, max_treedepth = 20),
                         backend = "cmdstanr",
                         data = focal_sum_ntm,
                         file = "model/m_aggfocal_tm_est.rds")

m_aggfocal_tm_ntm <- brm(agg_tm ~ cen_ntm  +  rs2 +  cen_ntm:rs2 + TY  + study_period 
                  + offset(logdur) + (1|subject),
                     family = negbinomial,
                     iter = 5000, warmup = 2500, seed = 13,
                     prior = c(prior(student_t(4,0,5), class = "b"),
                           prior(student_t(4,0,10), class = "Intercept"),
                           prior(student_t(4,0,10), class = "sd"),
                           prior(gamma(0.01,0.01), class = "shape")),
                     control=list(adapt_delta = 0.9999, max_treedepth = 20),
                     backend = "cmdstanr",
                     data = focal_sum_ntm,
                  file = "model/m_aggfocal_tm_ntm.rds")
```

**モデルチェック**  
```{r, include = FALSE}
check_m_aggfocal_tm_est <- dh_check_brms(m_aggfocal_tm_est)
check_m_aggfocal_tm_ntm <- dh_check_brms(m_aggfocal_tm_ntm)
```

いずれのモデルについても、分布から大きく外れていることはなく、過分散や外れ値の問題もないよう。  
```{r}
plotQQunif(check_m_aggfocal_tm_est)
plotQQunif(check_m_aggfocal_tm_ntm)
```

ゼロ過剰の問題もない。  
```{r}
testZeroInflation(check_m_aggfocal_tm_est)
testZeroInflation(check_m_aggfocal_tm_ntm)
```

VIFも発情メス数についてはやや高いものの、10以下には収まっている。    
```{r}
check_collinearity(m_aggfocal_tm_est)
check_collinearity(m_aggfocal_tm_ntm)
```

**結果の確認**  

いずれのモデルでも、発情の有無と調査期間のみが有意だった。  
```{r}
### 発情メス数
model_parameters(m_aggfocal_tm_est)
```
<br/>  

```{r}
### 群れ外オス数  
model_parameters(m_aggfocal_tm_ntm)
```
<br/>  


交互作用項のある変数の検討を行う。発情メス・非発情メスのいずれについても観察日の発情メス数や群れ外オス数の効果はなかった。  
```{r}
estimate_slopes(m_aggfocal_tm_est,
               trend = "cen_est",
               at = "rs2 = c(0,1)")
```
<br/>  

```{r}
estimate_slopes(m_aggfocal_tm_ntm,
               trend = "cen_ntm",
               at = "rs2 = c(0,1)")
```
<br/>  

発情の有無については、群れ外オス数や発情メス数に関わりなく非発情メスの方が発情メスよりも被攻撃頻度が有意に低い(図\@ref(fig:fig-aggfocal-rs-tm))。  
```{r fig-aggfocal-rs-tm, fig.dim = c(12,5), fig.cap = "群れ外オス数/発情メス数ごとの発情の有無の効果"}
estimate_contrasts(m_aggfocal_tm_ntm,
                   contrast = "rs2 = c(0,1)",
                   at = c("cen_ntm"),
                   length = 30) %>% 
  data.frame() -> estimate_cont_rs_tm_ntm

estimate_cont_rs_tm_ntm %>%
  mutate(no_ntm = cen_ntm + mean(focal_sum_ntm$no_ntm)) %>% 
  ggplot(aes(x = no_ntm, y = Difference))+
  geom_line()+
  geom_ribbon(aes(ymin = CI_low,
                  ymax = CI_high),
              alpha = 0.2)+
  geom_hline(yintercept = 0,
             color = "red")+
  theme_bw(base_size = 14)+
  theme(aspect.ratio = 1,
        plot.title = element_text(size = 13))+
  scale_x_continuous(breaks = seq(0,13,1))+
  labs(title = "Effect of estrous status\nby number of nontroop males",
       y = "anesrus - estrous",
       x = "no. of nontroop males") -> p_cont_rs_tm_ntm

estimate_contrasts(m_aggfocal_tm_est,
                   contrast = "rs2 = c(0,1)",
                   at = c("cen_est"),
                   length = 30) %>% 
  data.frame() -> estimate_cont_rs_tm_est

estimate_cont_rs_tm_est %>%
  mutate(no_est = cen_est + mean(focal_sum_ntm$no_est)) %>% 
  ggplot(aes(x = no_est, y = Difference))+
  geom_line()+
  geom_ribbon(aes(ymin = CI_low,
                  ymax = CI_high),
              alpha = 0.2)+
  geom_hline(yintercept = 0,
             color = "red")+
  theme_bw(base_size = 14)+
  theme(aspect.ratio = 1,
        plot.title = element_text(size = 13))+
  scale_x_continuous(breaks = seq(0,13,1))+
  labs(title = "Effect of estrous status\nby number of estrous females",
       y = "anesrus - estrous",
       x = "no. of estrous females") -> p_cont_rs_tm_est

p_cont_rs_tm_ntm + p_cont_rs_tm_est
```

###### 結果まとめ  
- 群れオスからの攻撃については、発情メス数や群れ外オス数の有意な影響はなかった。  
- 発情の有無のみが明確に影響を与えている要因だった。  

##### 群れ外オスからの攻撃頻度  
###### モデリング  
続いて、群れ外オスからの攻撃についてモデリングする。  

```{r}
m_aggfocal_ntm <- brm(agg_ntm ~ cen_ntm + cen_est + rs2 + cen_ntm:rs2  + cen_est:rs2 + TY + study_period 
                  + offset(logdur) + (1|subject),
                     family = negbinomial,
                     iter = 5000, warmup = 2500, seed = 13,
                     prior = c(prior(student_t(4,0,5), class = "b"),
                           prior(student_t(4,0,10), class = "Intercept"),
                           prior(student_t(4,0,10), class = "sd"),
                           prior(gamma(0.01,0.01), class = "shape")),
                     control=list(adapt_delta = 0.9999, max_treedepth = 20),
                     backend = "cmdstanr",
                     data = focal_sum_ntm,
                     file = "model/m_aggfocal_ntm.rds")

m_aggfocal_ntm2 <- brm(agg_ntm ~ cen_ntm  + rs2 + cen_ntm:rs2 + TY + study_period 
                  + offset(logdur) + (1|subject),
                     family = negbinomial,
                     iter = 5000, warmup = 2500, seed = 13,
                     prior = c(prior(student_t(4,0,5), class = "b"),
                           prior(student_t(4,0,10), class = "Intercept"),
                           prior(student_t(4,0,10), class = "sd"),
                           prior(gamma(0.01,0.01), class = "shape")),
                     control=list(adapt_delta = 0.9999, max_treedepth = 20),
                     backend = "cmdstanr",
                     data = focal_sum_ntm,
                     file = "model/m_aggfocal_ntm2.rds")
```

**モデルチェック**  
分布から大きく外れていることはなく、過分散や外れ値の問題もないよう。  
```{r, include = FALSE}
check_m_aggfocal_ntm <- dh_check_brms(m_aggfocal_ntm)
```

```{r}
plotQQunif(check_m_aggfocal_ntm)
```

ゼロ過剰の問題もない。  
```{r}
testZeroInflation(check_m_aggfocal_ntm)
```

VIFは全て10以下であり、そこまで多重共線性の問題はないよう。  
```{r}
check_collinearity(m_aggfocal_ntm)
```

**結果の確認**  
発情メス数、調査期間のみ有意な影響があった。なお、調査期間について2021年が2019年より被攻撃頻度が有意に低かったが、2020年と2019年の違いは有意ではなかった。  
```{r}
model_parameters(m_aggfocal_ntm)
```
<br/>  

*TY*の有無に関しては、90%確信区間には0は含まれなかった。  
```{r}
model_parameters(m_aggfocal_ntm, ci = 0.9)
```
<br/>  

交互作用項のある変数の検討を行う。  

まず、発情メス数については発情メス・非発情メスのいずれについても被攻撃頻度と正の関連があった。  
```{r}
estimate_slopes(m_aggfocal_ntm,
                trend = "cen_est",
                at = "rs2 = c(0,1)")
```
<br/>  

群れ外オス数については、発情メス・非発情メスのいずれについて有意な効果はなかった。  
```{r}
estimate_slopes(m_aggfocal_ntm,
                trend = "cen_ntm",
                at = "rs2 = c(0,1)")
```
<br/>  

発情の有無については、群れ外オス数や発情メス数に関わりなく非発情メスの方と発情メスの被攻撃頻度の差は有意ではなかった(図\@ref(fig:fig-aggfocal-rs-ntm))。  

```{r fig-aggfocal-rs-ntm, fig.dim = c(12,5), fig.cap = "群れ外オス数/発情メス数ごとの発情の有無の効果"}
estimate_contrasts(m_aggfocal_ntm,
                   contrast = "rs2 = c(0,1)",
                   at = c("cen_ntm"),
                   length = 30) %>% 
  data.frame() -> estimate_cont_rs_ntm_ntm

estimate_cont_rs_ntm_ntm %>%
  mutate(no_ntm = cen_ntm + mean(focal_sum_ntm$no_ntm)) %>% 
  ggplot(aes(x = no_ntm, y = Difference))+
  geom_line()+
  geom_ribbon(aes(ymin = CI_low,
                  ymax = CI_high),
              alpha = 0.2)+
  geom_hline(yintercept = 0,
             color = "red")+
  theme_bw(base_size = 14)+
  theme(aspect.ratio = 1,
        plot.title = element_text(size = 13))+
  scale_x_continuous(breaks = seq(0,13,1))+
  labs(title = "Effect of estrous status\nby number of nontroop males",
       y = "anesrus - estrous",
       x = "no. of nontroop males") -> p_cont_rs_ntm_ntm

estimate_contrasts(m_aggfocal_ntm,
                   contrast = "rs2 = c(0,1)",
                   at = c("cen_est"),
                   length = 30) %>% 
  data.frame() -> estimate_cont_rs_ntm_est

estimate_cont_rs_ntm_est %>%
  mutate(no_est = cen_est + mean(focal_sum_ntm$no_est)) %>% 
  ggplot(aes(x = no_est, y = Difference))+
  geom_line()+
  geom_ribbon(aes(ymin = CI_low,
                  ymax = CI_high),
              alpha = 0.2)+
  geom_hline(yintercept = 0,
             color = "red")+
  theme_bw(base_size = 14)+
  theme(aspect.ratio = 1,
        plot.title = element_text(size = 13))+
  scale_x_continuous(breaks = seq(0,13,1))+
  labs(title = "Effect of estrous status\nby number of estrous females",
       y = "anesrus - estrous",
       x = "no. of estrous females") -> p_cont_rs_ntm_est

p_cont_rs_ntm_ntm + p_cont_rs_ntm_est
```

###### 結果まとめ  
- 群れ外オスからの攻撃については、発情メス・非発情メスともに発情メス数が有意に被攻撃頻度と正に関連していた。    
- 発情の有無による被攻撃頻度の違いはそこまで顕著ではなかった。   
- *TY*の有無による被攻撃頻度の違いは有意な傾向。  

## 全生起サンプリングを用いた分析  
続いて、全生起サンプリングのデータを用いて同様の分析を行う。  

### データの加工  
6歳以上のメスについて、各メスが確認された時刻から追跡終了までが300分以上のメスのデータのみを用いる。  
```{r}
female_dur %>% 
  filter(!str_detect(study_period,"nm")) %>% 
  left_join(agg_female_all, by = c("date","femaleID")) %>% 
  replace_na(list(no_agg = 0)) %>% 
  left_join(agg_female_ntm, by = c("date","femaleID")) %>% 
  replace_na(list(agg_tm = 0, agg_ntm = 0)) %>% 
  mutate(ok = ifelse(no_agg == agg_tm + agg_ntm,1,0)) %>% 
  left_join(female_all, by = c("date", "femaleID")) %>% 
  filter(dur >= 300) -> agg_ao_all
```

観察日の群れ外オス数、発情メス数の情報を追加。  
```{r}
## 群れ外オス数  
male_all %>% 
  group_by(date) %>% 
  filter(ntm == "1") %>% 
  summarise(no_ntm= sum(presence)) %>% 
  ungroup() %>% 
  right_join(agg_ao_all) -> agg_ao_all_b

## 発情メス数  
female_all %>% 
  group_by(date) %>% 
  summarise(no_est = sum(rs2, na.rm = TRUE)) %>% 
  ungroup() %>% 
  right_join(agg_ao_all_b) -> agg_ao_all_c
```

*TY*と*IT*の確認状況を追加する。なお、1時間以上確認できた日を1、1時間未満しか確認できていない日を0とした。  
```{r}
## 2018
hr18 <- read_excel("C:/Users/Tsubasa Yamaguchi/Desktop/Study/data/2018mating/2018mating_raw.xlsx",
              sheet =　"male_presence") %>% 
        select(date,TY,IT)

## 2019
hr19 <- read_excel("C:/Users/Tsubasa Yamaguchi/Desktop/Study/data/2019mating/2019mating_raw.xlsx",
              sheet =　"male_presence_anal") %>% 
        select(date,TY,IT)

## 2020  
hr20 <- read_excel("C:/Users/Tsubasa Yamaguchi/Desktop/Study/DoctorStudy/data/2020mating/2020mating_raw.xlsx",
              sheet =　"male_presence_anal") %>% 
        select(date,TY,IT)

## 2021  
hr21 <- read_excel("C:/Users/Tsubasa Yamaguchi/Desktop/Study/DoctorStudy/data/2021mating/2021mating_raw.xlsx",
              sheet =　"male_presence_anal") %>% 
        select(date,TY)

## 結合して加工
bind_rows(hr18, hr19, hr20, hr21) %>% 
  replace_na(list(IT = 0)) %>% 
  mutate(date = as_date(date))-> hr_presence

agg_ao_all_c %>% 
  left_join(hr_presence, by = "date") -> agg_ao_all_d
```

各観察日の群れ追跡時間を追加する。また、群れ外オス数と発情メス数を中心化する。    
```{r}
agg_ao_all_d %>% 
  left_join(base_all %>% select(date,duration)) %>% 
  mutate(logdur = log(duration/60)) %>% 
  ungroup() %>% 
  mutate() %>% 
  filter(study_period != "m18") %>% 
  mutate(cen_est = no_est - mean(no_est),
         cen_ntm = no_ntm - mean(no_ntm))-> agg_ao_all_fin
```

データは以下の通り。  
```{r}
datatable(agg_ao_all_fin,
          options = list(scrollX = 30), 
          filter = list(position ="top"))
```

### 分析  
#### 群れオスと群れ外オスを区別しない  
まず、群れオスと群れ外オスの攻撃を区別しないで分析を行う。  

##### モデリング    
モデルの詳細は以下の通り。なお、群れ外オス数と発情メス数は中心化した。    

- 分布: 負の二項分布  
- 応答変数: 被攻撃回数(`no_agg`)    
- オフセット項: log(群れ追跡時間)(`logdur`)    
- 説明変数: 追跡個体の発情の有無(`rs2`)、観察日の群れ外オス数(`cen_ntm`)、発情メス数(`cen_est`)、発情の有無×群れ外オス数、発情の有無×発情メス数、*TY*の有無(`TY`)、調査期間(`study_period`)    
- ランダム切片: メスID(`femaleID`)、観察日(`date`)    

```{r}
m_aggao <- brm(no_agg ~ cen_ntm  + cen_est + rs2 + cen_ntm:rs2 + cen_est:rs2 + TY + study_period 
                  + offset(logdur) + (1|femaleID) + (1|date),
                     family = negbinomial,
                     iter = 5000, warmup = 2500, seed = 13,
                     prior = c(prior(student_t(4,0,5), class = "b"),
                           prior(student_t(4,0,10), class = "Intercept"),
                           prior(student_t(4,0,10), class = "sd"),
                           prior(gamma(0.01,0.01), class = "shape")),
                     control=list(adapt_delta = 0.9999, max_treedepth = 20),
                     backend = "cmdstanr",
                     data = agg_ao_all_fin %>% mutate(date = as.factor(date)),
                  file = "model/m_aggao.rds")
```

###### モデルチェック  
分布から大きく外れていることはなく、過分散や外れ値の問題もないよう。  
```{r, include = FALSE}
check_m_aggao <- dh_check_brms(m_aggao)
```

```{r}
plotQQunif(check_m_aggao)
```

ゼロ過剰の問題もない。  
```{r}
testZeroInflation(check_m_aggao)
```

VIFは全て10以下であり、そこまで多重共線性の問題はないよう。  
```{r}
check_collinearity(m_aggao)
```

###### 結果の確認  
発情メス数と群れ外オス数、*TY*の有無、発情の有無、調査期間が有意な影響。*TY*の有無については、*TY*がいる日は被攻撃頻度が有意に低下する。
```{r}
model_parameters(m_aggao)
```
<br/>  

交互作用項のある変数の検討を行う。  

まず、発情メス数については発情メス・非発情メスのいずれについても被攻撃頻度と正の関連があった。  
```{r}
estimate_slopes(m_aggao,
               trend = "cen_est",
               at = "rs2 = c(0,1)")
```
<br/>  

群れ外オス数については、発情の有無に限らず被攻撃頻度とは有意な正の関連があった。  
```{r}
estimate_slopes(m_aggao,
               trend = "cen_ntm",
               at = "rs2 = c(0,1)")
```
<br/>  

発情の有無については、群れ外オス数や発情メス数に関わりなく非発情メスの方が発情メスよりも被攻撃頻度が有意に低い(図\@ref(fig:fig-aggao-rs))。  

```{r fig-aggao-rs, fig.dim = c(12,5), fig.cap = "群れ外オス数/発情メス数ごとの発情の有無の効果"}
estimate_contrasts(m_aggao,
                   contrast = "rs2 = c(0,1)",
                   at = c("cen_ntm"),
                   length = 30) %>% 
  data.frame() -> estimate_cont_ao_rs_ntm

estimate_cont_ao_rs_ntm %>%
  mutate(no_ntm = cen_ntm + mean(agg_ao_all_fin$no_ntm)) %>% 
  ggplot(aes(x = no_ntm, y = Difference))+
  geom_line()+
  geom_ribbon(aes(ymin = CI_low,
                  ymax = CI_high),
              alpha = 0.2)+
  geom_hline(yintercept = 0,
             color = "red")+
  theme_bw(base_size = 14)+
  theme(aspect.ratio = 1,
        plot.title = element_text(size = 13))+
  scale_x_continuous(breaks = seq(0,13,1))+
  labs(title = "Effect of estrous status\nby number of nontroop males",
       y = "anesrus - estrous",
       x = "no. of nontroop males") -> p_cont_ao_rs_ntm

estimate_contrasts(m_aggao,
                   contrast = "rs2 = c(0,1)",
                   at = c("cen_est"),
                   length = 30) %>% 
  data.frame() -> estimate_cont_ao_rs_est

estimate_cont_ao_rs_est %>%
  mutate(no_est = cen_est + mean(agg_ao_all_fin$no_est)) %>% 
  ggplot(aes(x = no_est, y = Difference))+
  geom_line()+
  geom_ribbon(aes(ymin = CI_low,
                  ymax = CI_high),
              alpha = 0.2)+
  geom_hline(yintercept = 0,
             color = "red")+
  theme_bw(base_size = 14)+
  theme(aspect.ratio = 1,
        plot.title = element_text(size = 13))+
  scale_x_continuous(breaks = seq(0,13,1))+
  labs(title = "Effect of estrous status\nby number of estrous females",
       y = "anesrus - estrous",
       x = "no. of estrous females") -> p_cont_ao_rs_est

p_cont_ao_rs_ntm + p_cont_ao_rs_est
```

#### 群れオス・群れ外オスを区別する    
続いて、群れオスと群れ外オスの攻撃を区別して分析する。  
いずれの分析ではモデルは以下の通りで、群れオス・群れ外オスを区別しない場合と同じである。  

- 分布: 負の二項分布  
- 応答変数: 被攻撃回数(`no_agg`)    
- オフセット項: log(追跡時間)(`logdur`)    
- 説明変数: 追跡個体の発情の有無(`rs2`)、観察日の群れ外オス数(`cen_ntm`)、発情メス数(`cen_est`)、発情の有無×群れ外オス数、発情の有無×発情メス数、*TY*の有無(`TY`)、調査期間(`study_period`)    
- ランダム切片: 追跡個体ID  

##### 群れオスからの攻撃頻度  
###### モデリング    
まず、群れオスの攻撃についてモデリングする。  
```{r}
m_aggao_tm <- brm(agg_tm ~ cen_ntm  + cen_est + rs2 + cen_ntm:rs2 + cen_est:rs2 + TY + study_period 
                  + offset(logdur) + (1|femaleID) + (1|date),
                     family = negbinomial,
                     iter = 5000, warmup = 2500, seed = 13,
                     prior = c(prior(student_t(4,0,5), class = "b"),
                           prior(student_t(4,0,10), class = "Intercept"),
                           prior(student_t(4,0,10), class = "sd"),
                           prior(gamma(0.01,0.01), class = "shape")),
                     control=list(adapt_delta = 0.9999, max_treedepth = 20),
                     backend = "cmdstanr",
                     data = agg_ao_all_fin %>% mutate(date = as.factor(date)),
                  file = "model/m_aggao_tm.rds")
```

**モデルチェック**  
```{r, include = FALSE}
check_m_aggao_tm <- dh_check_brms(m_aggao_tm)
```

分布から大きく外れていることはなく、過分散や外れ値の問題もないよう。  
```{r}
plotQQunif(check_m_aggao_tm)
```

ゼロ過剰の問題もない。  
```{r}
testZeroInflation(check_m_aggao_tm)
```

VIFも10以下には収まっている。    
```{r}
check_collinearity(m_aggao_tm)
```

**結果の確認**  
発情メス数と群れ外オス数、*TY*の有無、発情の有無、調査期間が有意な影響。*TY*の有無については、*TY*がいる日は被攻撃頻度が有意に低下する。
```{r}
### 発情メス数
model_parameters(m_aggao_tm)
```
<br/>  


交互作用項のある変数の検討を行う。非発情メスのみで観察日の発情メス数が被攻撃頻度に有意に影響していた。  
```{r}
estimate_slopes(m_aggao_tm,
               trend = "cen_est",
               at = "rs2 = c(0,1)")
```
<br/>  

群れ外オス数についても、非発情メスのみで被攻撃頻度に有意に影響していた。  
```{r}
estimate_slopes(m_aggao_tm,
               trend = "cen_ntm",
               at = "rs2 = c(0,1)")
```
<br/>  

発情の有無については、群れ外オス数や発情メス数に関わりなく非発情メスの方が発情メスよりも被攻撃頻度が有意に低い(図\@ref(fig:fig-aggao-rs-tm))。  
```{r fig-aggao-rs-tm, fig.dim = c(12,5), fig.cap = "群れ外オス数/発情メス数ごとの発情の有無の効果"}
estimate_contrasts(m_aggao_tm,
                   contrast = "rs2 = c(0,1)",
                   at = c("cen_ntm"),
                   length = 30) %>% 
  data.frame() -> estimate_cont_ao_rs_tm_ntm

estimate_cont_ao_rs_tm_ntm %>%
  mutate(no_ntm = cen_ntm + mean(agg_ao_all_fin$no_ntm)) %>% 
  ggplot(aes(x = no_ntm, y = Difference))+
  geom_line()+
  geom_ribbon(aes(ymin = CI_low,
                  ymax = CI_high),
              alpha = 0.2)+
  geom_hline(yintercept = 0,
             color = "red")+
  theme_bw(base_size = 14)+
  theme(aspect.ratio = 1,
        plot.title = element_text(size = 13))+
  scale_x_continuous(breaks = seq(0,13,1))+
  labs(title = "Effect of estrous status\nby number of nontroop males",
       y = "anesrus - estrous",
       x = "no. of nontroop males") -> p_cont_ao_rs_tm_ntm

estimate_contrasts(m_aggao_tm,
                   contrast = "rs2 = c(0,1)",
                   at = c("cen_est"),
                   length = 30) %>% 
  data.frame() -> estimate_cont_ao_rs_tm_est

estimate_cont_ao_rs_tm_est %>%
  mutate(no_est = cen_est + mean(agg_ao_all_fin$no_est)) %>% 
  ggplot(aes(x = no_est, y = Difference))+
  geom_line()+
  geom_ribbon(aes(ymin = CI_low,
                  ymax = CI_high),
              alpha = 0.2)+
  geom_hline(yintercept = 0,
             color = "red")+
  theme_bw(base_size = 14)+
  theme(aspect.ratio = 1,
        plot.title = element_text(size = 13))+
  scale_x_continuous(breaks = seq(0,13,1))+
  labs(title = "Effect of estrous status\nby number of estrous females",
       y = "anesrus - estrous",
       x = "no. of estrous females") -> p_cont_ao_rs_tm_est

p_cont_rs_tm_ntm + p_cont_rs_tm_est
```


##### 群れ外オスからの攻撃頻度  
###### モデリング  
```{r}
m_aggao_ntm <- brm(agg_ntm ~ cen_ntm  + cen_est + rs2 + cen_ntm:rs2 + cen_est:rs2 + TY + study_period 
                  + offset(logdur) + (1|femaleID) + (1|date),
                     family = negbinomial,
                     iter = 5000, warmup = 2500, seed = 13,
                     prior = c(prior(student_t(4,0,5), class = "b"),
                           prior(student_t(4,0,10), class = "Intercept"),
                           prior(student_t(4,0,10), class = "sd"),
                           prior(gamma(0.01,0.01), class = "shape")),
                     control=list(adapt_delta = 0.9999, max_treedepth = 20),
                     backend = "cmdstanr",
                     data = agg_ao_all_fin %>% mutate(date = as.factor(date)),
                  file = "model/m_aggao_ntm.rds")
```

**モデルチェック**  
```{r, include = FALSE}
check_m_aggao_ntm <- dh_check_brms(m_aggao_ntm)
```

分布から大きく外れていることはなく、過分散や外れ値の問題もないよう。  
```{r}
plotQQunif(check_m_aggao_ntm)
```

ゼロ過剰の問題もない。  
```{r}
testZeroInflation(check_m_aggao_ntm)
```

VIFも10以下には収まっている。    
```{r}
check_collinearity(m_aggao_ntm)
```

**結果の確認**  
発情メス数と群れ外オス数、*TY*の有無、発情の有無、調査期間が有意な影響。*TY*の有無については、*TY*がいる日は被攻撃頻度が有意に低下する。
```{r}
### 発情メス数
model_parameters(m_aggao_ntm)
```
<br/>  


交互作用項のある変数の検討を行う。非発情メス・発情メスいずれも観察日の発情メス数が被攻撃頻度に有意に影響していた。  
```{r}
estimate_slopes(m_aggao_ntm,
               trend = "cen_est",
               at = "rs2 = c(0,1)")
```
<br/>  

群れ外オス数についても、非発情メス・発情メスいずれも被攻撃頻度に有意に影響していた。  
```{r}
estimate_slopes(m_aggao_ntm,
               trend = "cen_ntm",
               at = "rs2 = c(0,1)")
```
<br/>  

発情の有無については、群れ外オス数や発情メス数がそこまで多くなければ非発情メス数の方が発情メスよりも被攻撃頻度が有意に低かった(図\@ref(fig:fig-aggao-rs-ntm))。  
```{r fig-aggao-rs-ntm, fig.dim = c(12,5), fig.cap = "群れ外オス数/発情メス数ごとの発情の有無の効果"}
estimate_contrasts(m_aggao_ntm,
                   contrast = "rs2 = c(0,1)",
                   at = c("cen_ntm"),
                   length = 30) %>% 
  data.frame() -> estimate_cont_ao_rs_ntm_ntm

estimate_cont_ao_rs_ntm_ntm %>%
  mutate(no_ntm = cen_ntm + mean(agg_ao_all_fin$no_ntm)) %>% 
  ggplot(aes(x = no_ntm, y = Difference))+
  geom_line()+
  geom_ribbon(aes(ymin = CI_low,
                  ymax = CI_high),
              alpha = 0.2)+
  geom_hline(yintercept = 0,
             color = "red")+
  theme_bw(base_size = 14)+
  theme(aspect.ratio = 1,
        plot.title = element_text(size = 13))+
  scale_x_continuous(breaks = seq(0,13,1))+
  labs(title = "Effect of estrous status\nby number of nontroop males",
       y = "anesrus - estrous",
       x = "no. of nontroop males") -> p_cont_ao_rs_ntm_ntm

estimate_contrasts(m_aggao_ntm,
                   contrast = "rs2 = c(0,1)",
                   at = c("cen_est"),
                   length = 30) %>% 
  data.frame() -> estimate_cont_ao_rs_ntm_est

estimate_cont_ao_rs_ntm_est %>%
  mutate(no_est = cen_est + mean(agg_ao_all_fin$no_est)) %>% 
  ggplot(aes(x = no_est, y = Difference))+
  geom_line()+
  geom_ribbon(aes(ymin = CI_low,
                  ymax = CI_high),
              alpha = 0.2)+
  geom_hline(yintercept = 0,
             color = "red")+
  theme_bw(base_size = 14)+
  theme(aspect.ratio = 1,
        plot.title = element_text(size = 13))+
  scale_x_continuous(breaks = seq(0,13,1))+
  labs(title = "Effect of estrous status\nby number of estrous females",
       y = "anesrus - estrous",
       x = "no. of estrous females") -> p_cont_ao_rs_ntm_est

p_cont_ao_rs_ntm_ntm + p_cont_ao_rs_ntm_est
```
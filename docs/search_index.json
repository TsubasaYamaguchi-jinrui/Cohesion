[["index.html", "交尾期の群れ内の凝集性に関する分析 本稿の目的", " 交尾期の群れ内の凝集性に関する分析 Tsubasa Yamaguchi 2023-06-25 本稿の目的 本稿は、個体追跡データをもとに なお、本稿の作成に使用したファイルとRのコードは筆者のGithubですべて閲覧できる。 "],["Chapter0.html", "0. パッケージの読み込み", " 0. パッケージの読み込み ## データハンドリング library(tidyverse) library(lubridate) library(readxl) library(dbplyr) ## モデリング library(lme4) library(glmmTMB) library(brms) library(rstan) library(DHARMa) library(DHARMa.helpers) library(easystats) library(ggeffects) library(ggdist) ## ベイズモデルの設定 rstan_options(auto_write = TRUE) options(mc.cores = parallel::detectCores()) ## グラフや表関連 library(patchwork) library(flextable) library(ggeffects) library(DT) library(knitr) library(kableExtra) library(stargazer) library(ggsci) library(lemon) library(ggplotify) library(ggsignif) ## フォント関連 library(extrafont) require(systemfonts) require(fontregisterer) なお、本稿はRの基本操作とtidyverseパッケージによるデータハンドリングができることを前提としている。tidyverseパッケージを用いたデータ処理については、以下の書籍などを参照。 R for Data Science (Wickham &amp; Grolemund, 2016) 電子書籍, 日本語 R Graphics Coocbook 2nd Edition (Chang, 2018) 電子書籍, 日本語 RユーザのためのRstudio[実践]入門~tidyverseによるモダンな分析フローの世界 改訂2版 (松村 et al., 2021) 出版社サイト References Chang, W. (2018). R graphics cookbook: Practical recipes for visualizing data. “O’Reilly Media, Inc.” Wickham, H., &amp; Grolemund, G. (2016). R for data science: Import, tidy, transform, visualize, and model data. “O’Reilly Media, Inc.” 松村優哉., 湯谷啓明., 紀ノ定保礼., &amp; 前田和. (2021). RユーザのためのRstudio[実践]入門 tidyverseによるモダンな分析フローの世界 改訂2版. 技術評論社. "],["Chapter1.html", "1 使用する基礎データ", " 1 使用する基礎データ 以下の基礎的な情報について、データフレームを作成 daily_data18: 2018年交尾期の日ごとの追跡時間、発情メス数、群れ外オス数など。 daily_data19: 2019年交尾期の日ごとの追跡時間、発情メス数、群れ外オス数など。 daily_data20: 2020年交尾期の日ごとの追跡時間、発情メス数、群れ外オス数など。 daily_data21: 2021年交尾期の日ごとの追跡時間、発情メス数、群れ外オス数など。 daily_data19_nm: 2019年非交尾期の日ごとの追跡時間など。 daily_data21_nm: 2021年非交尾期の日ごとの追跡時間など。 daily_data22_nm: 2021年非交尾期の日ごとの追跡時間など。 female18: 2018年交尾期の全メスの確認状況と発情状況 female19: 2019年交尾期の全メスの確認状況と発情状況 female20: 2020年交尾期の全メスの確認状況と発情状況 female21: 2021年交尾期の全メスの確認状況と発情状況 male18: 2018年交尾期のオスの出欠状況 male19: 2019年交尾期のオスの出欠状況 male20: 2020年交尾期のオスの出欠状況 male21: 2021年交尾期のオスの出欠状況 個体追跡データの概要について、以下のデータフレームを作成 focal18: 2018年交尾期の個体追跡の時間と被攻撃回数 focal19: 2019年交尾期の個体追跡の時間と被攻撃回数 focal20: 2020年交尾期の個体追跡の時間と被攻撃回数 focal21: 2021年交尾期の個体追跡の時間と被攻撃回数 focal21_nm: 2021年非交尾期の個体追跡の時間 focal22_nm: 2022年非交尾期の個体追跡の時間 "],["focal_cleaning.html", "2 データクリーニング 2.1 データの読み込み 2.2 データの加工", " 2 データクリーニング 2019~2021年交尾期の個体追跡データを読み込み、データを加工する。 2.1 データの読み込み 個体追跡データを読み込む。 ## 2018交尾期 focal_raw18 &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/data/2018mating/2018mating_raw.xlsx&quot;, sheet = &quot;focal_raw&quot;, col_types = c(rep(&quot;numeric&quot;,2),rep(&quot;date&quot;,3),rep(&quot;text&quot;,1),rep(&quot;numeric&quot;,2), rep(&quot;text&quot;,2),&quot;numeric&quot;,&quot;text&quot;, rep(&quot;numeric&quot;,3),rep(&quot;text&quot;,9),rep(&quot;numeric&quot;,2),rep(&quot;text&quot;,6),rep(&quot;numeric&quot;,5),rep(&quot;text&quot;,2))) %&gt;% mutate(start_time = as_datetime(str_c(date,&quot; &quot;, format(as.POSIXct(start_time), format = &quot;%H:%M:%S&quot;)))) %&gt;% mutate(fin_time = as_datetime(str_c(date,&quot; &quot;, format(as.POSIXct(fin_time), format = &quot;%H:%M:%S&quot;)))) ## 2019交尾期 focal_raw19 &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/data/2019mating/2019mating_raw.xlsx&quot;, sheet = &quot;focal_raw&quot;, col_types = c(rep(&quot;numeric&quot;,2),rep(&quot;date&quot;,3),rep(&quot;text&quot;,1),rep(&quot;numeric&quot;,2), rep(&quot;text&quot;,2),&quot;numeric&quot;,&quot;text&quot;, rep(&quot;numeric&quot;,3),rep(&quot;text&quot;,9),rep(&quot;numeric&quot;,2),rep(&quot;text&quot;,6),rep(&quot;numeric&quot;,5),rep(&quot;text&quot;,2))) %&gt;% mutate(start_time = as_datetime(str_c(date,&quot; &quot;, format(as.POSIXct(start_time), format = &quot;%H:%M:%S&quot;)))) %&gt;% mutate(fin_time = as_datetime(str_c(date,&quot; &quot;, format(as.POSIXct(fin_time), format = &quot;%H:%M:%S&quot;)))) ## 2020交尾期 focal_raw20 &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/DoctorStudy/data/2020mating/2020mating_raw.xlsx&quot;, sheet = &quot;focal_raw&quot;, col_types = c(rep(&quot;numeric&quot;,2),rep(&quot;date&quot;,3),rep(&quot;text&quot;,1),rep(&quot;numeric&quot;,2), rep(&quot;text&quot;,2), &quot;numeric&quot;,&quot;text&quot;, rep(&quot;numeric&quot;,3),rep(&quot;text&quot;,21),rep(&quot;numeric&quot;,2),rep(&quot;text&quot;,4),rep(&quot;numeric&quot;,4),&quot;text&quot;,&quot;numeric&quot;,&quot;text&quot;)) %&gt;% mutate(start_time = as_datetime(str_c(date,&quot; &quot;, format(as.POSIXct(start_time), format = &quot;%H:%M:%S&quot;)))) %&gt;% mutate(fin_time = as_datetime(str_c(date,&quot; &quot;, format(as.POSIXct(fin_time), format = &quot;%H:%M:%S&quot;)))) ## 2021交尾期 focal_raw21 &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/DoctorStudy/data/2021mating/2021mating_raw.xlsx&quot;, sheet = &quot;focal_raw&quot;, col_types = c(rep(&quot;numeric&quot;,2),rep(&quot;date&quot;,3),rep(&quot;text&quot;,1),rep(&quot;numeric&quot;,2), rep(&quot;text&quot;,2), &quot;numeric&quot;,&quot;text&quot;, rep(&quot;numeric&quot;,3), rep(&quot;text&quot;,21),rep(&quot;numeric&quot;,2),rep(&quot;text&quot;,4),rep(&quot;numeric&quot;,4),&quot;text&quot;,&quot;numeric&quot;,&quot;text&quot;)) %&gt;% mutate(start_time = as_datetime(str_c(date,&quot; &quot;, format(as.POSIXct(start_time), format = &quot;%H:%M:%S&quot;)))) %&gt;% mutate(fin_time = as_datetime(str_c(date,&quot; &quot;, format(as.POSIXct(fin_time), format = &quot;%H:%M:%S&quot;)))) ## まとめる focal_raw18 %&gt;% bind_rows(focal_raw19, focal_raw20, focal_raw21) %&gt;% mutate(study_period = ifelse(date &lt;= &quot;2018-12-10&quot;,&quot;m18&quot;, ifelse(date &gt;= &quot;2019-09-01&quot; &amp; date &lt;= &quot;2019-12-31&quot;,&quot;m19&quot;, ifelse(date &gt;= &quot;2020-09-01&quot; &amp; date &lt;= &quot;2020-12-31&quot;,&quot;m20&quot;,&quot;m21&quot;)))) %&gt;% mutate(year = year(date)) %&gt;% mutate(no_focal = str_c(study_period,&quot;_&quot;,no_focal)) %&gt;% dplyr::select(-(app_sub:no_lv2)) -&gt; focal_raw データは以下の通り。 datatable(focal_raw, options = list(scrollX = 60)) 2.2 データの加工 2.2.1 メス情報の追加 2.2.1.1 追跡個体の発情状態と各観察日の確認メス数の追加 各観察日に群れで確認されたメス数(6歳以上)と、追跡個体の発情状態の列を追加する。 female18 %&gt;% bind_rows(female19) %&gt;% bind_rows(female20) %&gt;% bind_rows(female21) -&gt; female_all female_all %&gt;% filter(age &gt;= 6) %&gt;% group_by(date) %&gt;% summarise(no_female = sum(presence)) -&gt; no_female focal_raw %&gt;% left_join(no_female, by = &quot;date&quot;) %&gt;% left_join(female_all %&gt;% dplyr::select(date, femaleID, rank, rs2), by = c(&quot;date&quot;, &quot;subject&quot; = &quot;femaleID&quot;)) -&gt; focal_raw_b 2.2.1.2 各観察日の発情メス数のデータを追加 ## 発情メス数の追加 female_all %&gt;% group_by(date) %&gt;% summarise(no_est = sum(rs2, na.rm = TRUE)) %&gt;% ungroup() %&gt;% right_join(focal_raw_b) -&gt; focal_raw_c 2.2.2 オスの情報の追加 2.2.2.1 群れ外オスの数 各観察日に群れで確認された群れオス以外のオスの数(no_ntm)を追加する。なお、2018年についてはデータがない。 各観察期間について以下のオスたちを群れオスとした。 2018~2019年: TY、IT、LK、KR 2020年: TY、IT、KR、KM 2021年: TY、KR、KM male19 %&gt;% bind_rows(male20) %&gt;% bind_rows(male21) %&gt;% mutate(year = year(date)) %&gt;% mutate(ntm = ifelse(year == &quot;2019&quot; &amp; maleID %in% c(&quot;TY&quot;,&quot;IT&quot;,&quot;KR&quot;,&quot;LK&quot;),0, ifelse(year == &quot;2020&quot; &amp; maleID %in% c(&quot;TY&quot;,&quot;IT&quot;,&quot;KR&quot;),0, ifelse(year == &quot;2021&quot; &amp; maleID %in% c(&quot;TY&quot;,&quot;KR&quot;,&quot;KM&quot;),0,1)))) %&gt;% replace_na(list(presence = 0))-&gt; male_all male_all %&gt;% group_by(date) %&gt;% filter(ntm == &quot;1&quot;) %&gt;% summarise(no_ntm= sum(presence)) %&gt;% ungroup() %&gt;% right_join(focal_raw_c, by = &quot;date&quot;) -&gt; focal_raw_d 2.2.2.2 TYとITの確認状況 調査期間中、第一位オスのタイヨウ(TY)と第二位オスのイツモ(IT)の群れへの出入りが頻繁に観察された。 そこで、彼らが個体追跡時にいたか否かについての列(TY、IT)を追加する。 彼らが確認できた時刻に関するデータを読み込む。 hrmales_pre19 &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/data/2019mating/2019mating_raw.xlsx&quot;, sheet = &quot;male_presence_long&quot;, col_types = c(&quot;date&quot;,&quot;text&quot;,&quot;numeric&quot;,&quot;date&quot;,&quot;date&quot;)) %&gt;% mutate(in_atleast = as_datetime(str_c(date,&quot; &quot;, format(as.POSIXct(in_atleast), format = &quot;%H:%M:%S&quot;)))) %&gt;% mutate(out_atleast = as_datetime(str_c(date,&quot; &quot;, format(as.POSIXct(out_atleast), format = &quot;%H:%M:%S&quot;)))) hrmales_pre20 &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/DoctorStudy/data/2020mating/2020mating_raw.xlsx&quot;, sheet = &quot;male_presence_long&quot;, col_types = c(&quot;date&quot;,&quot;text&quot;,&quot;numeric&quot;,rep(&quot;text&quot;,2),&quot;date&quot;,&quot;date&quot;,&quot;numeric&quot;)) %&gt;% dplyr::select(-`in`,-out, -all_day) %&gt;% mutate(in_atleast = as_datetime(str_c(date,&quot; &quot;, format(as.POSIXct(in_atleast), format = &quot;%H:%M:%S&quot;)))) %&gt;% mutate(out_atleast = as_datetime(str_c(date,&quot; &quot;, format(as.POSIXct(out_atleast), format = &quot;%H:%M:%S&quot;)))) hrmales_pre21 &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/DoctorStudy/data/2021mating/2021mating_raw.xlsx&quot;, sheet = &quot;male_presence_long&quot;, col_types = c(&quot;date&quot;,&quot;text&quot;,&quot;numeric&quot;,&quot;date&quot;,&quot;date&quot;)) %&gt;% mutate(in_atleast = as_datetime(str_c(date,&quot; &quot;, format(as.POSIXct(in_atleast), format = &quot;%H:%M:%S&quot;)))) %&gt;% mutate(out_atleast = as_datetime(str_c(date,&quot; &quot;, format(as.POSIXct(out_atleast), format = &quot;%H:%M:%S&quot;)))) hrmales_pre &lt;- bind_rows(hrmales_pre19, hrmales_pre20, hrmales_pre21) 個体追跡データのデータシートに列を追加する。 ## データの加工 hrmales_pre %&gt;% left_join(bind_rows(base_19b,base_20b,base_21b) %&gt;% dplyr::select(date, start, fin), by = &quot;date&quot;) %&gt;% mutate(in_atleast = ifelse(male_presence == &quot;1&quot; &amp; is.na(in_atleast), start, in_atleast)) %&gt;% mutate(out_atleast = ifelse(male_presence == &quot;1&quot; &amp; is.na(out_atleast), fin, out_atleast)) %&gt;% mutate(in_atleast = as_datetime(in_atleast), out_atleast = as_datetime(out_atleast)) %&gt;% dplyr::select(-start,-fin) -&gt; hrmales_pre_b ## TY focal_raw_d %&gt;% left_join(hrmales_pre_b %&gt;% filter(maleID == &quot;TY&quot;), by = &quot;date&quot;) %&gt;% mutate(TY = ifelse(male_presence == &quot;0&quot;,0, ifelse(male_presence == &quot;1&quot; &amp; start_time &gt;= in_atleast &amp; fin_time &lt;= out_atleast, 1, ifelse(male_presence == &quot;1&quot; &amp; fin_time &lt;= in_atleast, 0, ifelse(male_presence == &quot;1&quot; &amp; start_time &gt;= out_atleast, 0, 2))))) %&gt;% dplyr::select(-male_presence, -in_atleast, -out_atleast, -maleID)-&gt; focal_raw_e ## IT focal_raw_e %&gt;% left_join(hrmales_pre_b %&gt;% filter(maleID == &quot;IT&quot;), by = &quot;date&quot;) %&gt;% mutate(IT = ifelse(male_presence == &quot;0&quot;,0, ifelse(male_presence == &quot;1&quot; &amp; start_time &gt;= in_atleast &amp; fin_time &lt;= out_atleast, 1, ifelse(male_presence == &quot;1&quot; &amp; fin_time &lt;= in_atleast, 0, ifelse(male_presence == &quot;1&quot; &amp; start_time &gt;= out_atleast, 0, 2))))) %&gt;% dplyr::select(-male_presence, -in_atleast, -out_atleast, -maleID) -&gt; focal_raw_f ## 2018年については出入りはないので出欠状況 male_pre18 %&gt;% dplyr::select(date, TY,IT) %&gt;% rename(TY18 = TY, IT18 = IT) %&gt;% right_join(focal_raw_f, by = &quot;date&quot;) %&gt;% mutate(TY = ifelse(study_period == &quot;m18&quot;, TY18,TY)) %&gt;% mutate(IT = ifelse(study_period == &quot;m18&quot;, IT18, IT)) %&gt;% dplyr::select(-TY18, -IT18)-&gt; focal_raw_g フォーカルの途中でTYまたはITの確認状況が変わったものが５つあった。 focal_raw_g %&gt;% filter(IT == &quot;2&quot;| TY == &quot;2&quot;) %&gt;% distinct(date, no_focal, subject, TY, IT) 2.2.2.3 フォーカルを攻撃したオスのID フォーカルが攻撃を受けた際の攻撃したオスのIDを表す列を作成する。 focal_raw_g %&gt;% replace_na(list(agg_focal = 0)) %&gt;% replace_na(list(victim1 = &quot;NA&quot;, victim2 = &quot;NA&quot;, aggressor1 = &quot;NA&quot;, aggressor2 = &quot;NA&quot;)) %&gt;% mutate(if_victim1 = ifelse(agg_focal == 1 &amp; str_detect(victim1, subject),1,0), if_victim2 = ifelse(agg_focal == 1 &amp; str_detect(victim2, subject),1,0)) %&gt;% mutate(aggressor_focal = ifelse(if_victim1 == 1 &amp; if_victim2 == 1, str_c(aggressor1,&quot;,&quot;,aggressor2), ifelse(if_victim1 == 1 , aggressor1, ifelse(if_victim2 == 1, aggressor2,NA)))) %&gt;% separate(aggressor_focal, into = c(&quot;aggressor_focal1&quot;,&quot;aggressor_focal2&quot;), sep = &quot;,&quot;)-&gt; focal_raw_fin 加工したデータは以下の通り。 datatable(focal_raw_fin, options = list(scrollX = 60, filter = list(position = &#39;top&#39;))) "],["cost_of_aggression.html", "3 オスの攻撃はメスのコストになっているのか 3.1 交尾期と非交尾期の比較 3.2 交尾期内での被攻撃頻度と怪我の関連", " 3 オスの攻撃はメスのコストになっているのか 本章では、オスからの攻撃がメスの怪我の有無と関連しているかを調べることで、オスの攻撃がメスのコストになっているかを検討する。 3.1 交尾期と非交尾期の比較 3.1.1 被攻撃頻度 前提として、交尾期には非交尾期よりもオスからメスへの攻撃頻度が高いのかを検討する。ここでは、個体追跡中にメスが攻撃を受けた頻度の比較を行う。なお、交尾期のデータは対象個体が発情しているときとしていないときで分ける。 3.1.1.1 データの読み込み・加工 まず、個体追跡データから各フォーカルセッション中に攻撃を受けた回数を算出するためにデータを読み込み、加工する。 交尾期 focal_list_m &lt;- focal_raw_fin %&gt;% mutate(if_victim1 = ifelse(agg_focal == &quot;1&quot; &amp; str_detect(victim1, subject),1,0), if_victim2 = ifelse(agg_focal == &quot;1&quot; &amp; str_detect(victim2, subject),1,0)) %&gt;% group_by(no_focal, date, subject, study_period,rs2) %&gt;% summarise(duration = max(time), no_agg1 = sum(if_victim1, na.rm = TRUE), no_agg2 = sum(if_victim2, na.rm = TRUE)) %&gt;% ungroup() %&gt;% mutate(no_agg = no_agg1 + no_agg2) %&gt;% select(-no_agg1, -no_agg2) 非交尾期 ## 2019年 focal_list19nm &lt;- focal_list19nm &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/data/2019nonmating/2019nonmating_raw.xlsx&quot;, sheet = &quot;focal_raw&quot;) %&gt;% group_by(no_focal, date, subject) %&gt;% summarise(duration = max(time), no_agg = sum(agg_focal)) %&gt;% ungroup() %&gt;% mutate(study_period = &quot;nm19&quot;, no_focal = str_c(study_period,&quot;_&quot;,no_focal)) ## 2021年 focal_list21nm &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/DoctorStudy/data/2021nonmating/2021nonmating_raw.xlsx&quot;, sheet = &quot;focal_list&quot;) %&gt;% mutate(no_focal = str_c(study_period,&quot;_&quot;,no_focal)) ## 2022年 focal_list22nm &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/DoctorStudy/data/2022nonmating/2022nonmating_raw.xlsx&quot;, sheet = &quot;focal_list&quot;) %&gt;% mutate(no_focal = str_c(study_period,&quot;_&quot;,no_focal)) 全データを結合する。分析には、60分以上追跡した個体追跡セッションのみを用いる。 focal_list &lt;- bind_rows(focal_list_m,focal_list19nm, focal_list21nm, focal_list22nm) %&gt;% replace_na(list(rs2 = 0)) %&gt;% mutate(mating = ifelse(str_detect(study_period,&quot;nm&quot;),0,1)) %&gt;% mutate(cat = ifelse(rs2 == &quot;1&quot;,&quot;est&quot;, ifelse(mating == &quot;0&quot;, &quot;nm&quot;, &quot;nonest&quot;))) %&gt;% filter(duration &gt;= 60) %&gt;% mutate(logdur = log(duration/60)) データは以下の通り。 datatable(focal_list, options = list(scrollX = 20)) 3.1.1.2 分析 3.1.1.2.1 モデリング それでは、分析を行う。モデルの概要は以下の通り。 事前分布には弱情報事前分布を用いた。 分布: 負の二項分布 リンク関数: log 応答変数: オスから攻撃された回数(no_agg) オフセット項: 各セッションの観察時間の対数(logdur) 説明変数: メスの発情状態cat(交尾期発情メスest、交尾期費発情nonest、非交尾期nm) ランダム切片: 追跡個体(subject)、調査期間(study_period) m_aggcomp &lt;- brm(no_agg ~ cat + offset(logdur) + (1|subject) + (1|study_period), family = negbinomial, iter = 5000, warmup = 2500, seed = 13, prior = c(prior(student_t(4,0,10), class = &quot;b&quot;), prior(student_t(4,0,10), class = &quot;Intercept&quot;), prior(student_t(4,0,10), class = &quot;sd&quot;), prior(gamma(0.01,0.01), class = &quot;shape&quot;)), control=list(adapt_delta = 0.9999, max_treedepth = 20), backend = &quot;cmdstanr&quot;, data = focal_list, file = &quot;model/m_aggcomp.rds&quot;) 3.1.1.2.1.1 モデルチェック DHARMaパッケージ及び、そのヘルパーパッケージであるDHARMa.helpersパッケージを用いてモデルチェックを行う。 分布から大きく外れていることはなく、過分散や外れ値の問題もないよう。 plotQQunif(check_aggcomp) ゼロ過剰の問題もなかった。 testZeroInflation(check_aggcomp) ## ## DHARMa zero-inflation test via comparison to expected zeros with ## simulation under H0 = fitted model ## ## data: simulationOutput ## ratioObsSim = 0.99851, p-value = 0.974 ## alternative hypothesis: two.sided 3.1.1.2.1.2 結果の確認 モデルの結果は以下の通り。Rhatはすべて1.01以下であり、収束の問題はないと思われる。有向サンプルサイズにも大きな問題はない。 model_parameters(m_aggcomp) 多重比較の結果は以下の通り。被攻撃頻度は交尾期発情 &gt; 交尾期非発情 &gt; 非交尾期で、いずれの差も有意。 estimate_contrasts(m_aggcomp, contrast = &quot;cat&quot;) 3.1.1.2.1.3 結果の図示 posterior_samples(m_aggcomp) %&gt;% select(1,2,3) %&gt;% rename(&quot;est&quot; = 1, &quot;nm&quot; = 2, &quot;nonest&quot; = 3) %&gt;% tidyr::expand(data.frame(cat = c(&quot;est&quot;,&quot;nonest&quot;,&quot;nm&quot;)), nesting(est, nm, nonest)) %&gt;% mutate(lambda = ifelse(cat == &quot;est&quot;, exp(est), ifelse(cat == &quot;nonest&quot;, exp(est+ nonest), ifelse(cat == &quot;nm&quot;, exp(est + nm),&quot;NA&quot;)))) %&gt;% mutate(lambda = as.numeric(lambda)) %&gt;% group_by(cat) %&gt;% summarise(Mean = mean(lambda), CI_low = quantile(lambda, 0.025), CI_high = quantile(lambda, 0.975)) -&gt; mean_aggcomp focal_list %&gt;% ungroup() %&gt;% mutate(cat = fct_relevel(cat,&quot;nm&quot;,&quot;nonest&quot;,&quot;est&quot;)) %&gt;% ggplot(aes(x = cat, y = no_agg*60/duration))+ geom_violin(scale = &quot;width&quot;, fill = &quot;grey65&quot;, color = &quot;white&quot;, bw = 0.23)+ geom_boxplot(width = 0.3, size = 0.7, outlier.alpha = 0, fill = &quot;grey42&quot;) + geom_pointrange(data = mean_aggcomp, aes(y = Mean, ymin = CI_low, ymax = CI_high), color = &quot;white&quot;, size = 0.3)+ geom_errorbar(data = mean_aggcomp, aes(y = Mean, ymin = CI_low, ymax = CI_high), width = 0.1, linewidth = 0.8, color = &quot;white&quot;)+ geom_signif(comparisons = list(c(&quot;nm&quot;,&quot;nonest&quot;)), y_position = 2.1, annotation = &quot;***&quot;) + geom_signif(comparisons = list(c(&quot;nonest&quot;,&quot;est&quot;)), y_position = 4.85, annotation = &quot;***&quot;) + geom_signif(comparisons = list(c(&quot;nm&quot;,&quot;est&quot;)), y_position = 5.3, annotation = &quot;***&quot;) + scale_y_continuous(breaks = seq(0,6,1)) + theme_bw(base_size = 15)+ labs(x = &quot;&quot;, y = &quot;被\\n攻\\n撃\\n頻\\n度\\n(回/h)&quot;) + scale_x_discrete(labels = c(&quot;非交尾期&quot;, &quot;交尾期\\n(非発情)&quot;,&quot;交尾期\\n(発情)&quot;))+ theme(axis.title.y = element_text(angle = 0, vjust = 0.5, family = &quot;Yu Mincho&quot;), axis.text.x = element_text(family = &quot;Yu Mincho&quot;), axis.text.y = element_text(family = &quot;Times New Roman&quot;, size = 18)) -&gt; p_aggcomp # ggsave(&quot;figure/p_aggcomp.png&quot;, p_aggcomp, width = 120, height = 120, units = &quot;mm&quot;, dpi = 600) 結果は以下のようになる(図3.1)。 図3.1: 季節ごとの被攻撃頻度 3.1.2 怪我の頻度 それでは、実際にオスの攻撃が多い交尾期に怪我が多くなるかを調べる。先ほど同様に、交尾期のデータは対象個体が発情しているときとしていないときで分ける。 3.1.2.1 データの読み込みと加工 各メスがそれぞれの観察日に群れで最初に確認されてから、群れの観察を終了するまでの時間の長さを算出する。分析には少なくとも300分以上確認出来た個体のデータのみを用いる。2018年交尾期は確認時刻のデータがないため、それを除いた調査期間のデータを用いる。 まずは、メスが確認された時刻のデータを読み込む。 female_time &lt;- read_csv(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/data/combined_data/female_pre_all.csv&quot;) %&gt;% mutate(date = as_date(date)) att &lt;- read_csv(&quot;data/attributes.csv&quot;) 確認できた時間の長さを算出する。 base_18b %&gt;% bind_rows(base_19_nm, base_19b, base_20_nm, base_20b, base_21_nm, base_21b, base_22_nm) -&gt; base_all female_time %&gt;% pivot_longer(cols = Kur:Har, names_to = &quot;femaleID&quot;, values_to = &quot;presence&quot;) %&gt;% left_join(base_all %&gt;% select(date, start, fin, suspend, restart), by = &quot;date&quot;) %&gt;% ## 死亡個体と確認時間不明個体、非対称個体(6歳未満)は除く filter(presence != &quot;?&quot; &amp; presence != &quot;DD&quot; &amp; presence != &quot;NS&quot; &amp; presence != &quot;NA&quot;) %&gt;% mutate(date = as_date(date)) %&gt;% mutate(presence = str_c(date,&quot; &quot;, presence)) %&gt;% mutate(presence = as_datetime(presence)) %&gt;% mutate(suspend_time = as.numeric(restart - suspend)) %&gt;% mutate(dur = ifelse(is.na(suspend), as.numeric(fin - presence), ifelse(!is.na(suspend) &amp; presence &lt;= suspend, as.numeric(fin - presence) - suspend_time, ifelse(!is.na(suspend) &amp; presence &gt;= restart, as.numeric(fin - presence), &quot;NA&quot;)))) %&gt;% mutate(dur = as.numeric(dur)) %&gt;% mutate(season = ifelse(month(date)&gt;=9 &amp; month(date) &lt;= 12, &quot;m&quot;, &quot;nm&quot;)) %&gt;% mutate(study_period = str_c(season,str_sub(year(date),3,4))) %&gt;% dplyr::select(date, femaleID, study_period, dur) -&gt; female_dur 怪我のデータを読み込み、加工する。 ## 交尾期 injury18 &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/data/2018mating/2018mating_raw.xlsx&quot;, sheet = &quot;injury&quot;) injury19 &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/data/2019mating/2019mating_raw.xlsx&quot;, sheet = &quot;injury&quot;) injury20 &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/DoctorStudy/data/2020mating/2020mating_raw.xlsx&quot;,sheet = &quot;injury&quot;) injury21 &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/DoctorStudy/data/2021mating/2021mating_raw.xlsx&quot;,sheet = &quot;injury&quot;) ## 非交尾期 injury19nm &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/data/2019nonmating/2019nonmating_raw.xlsx&quot;, sheet = &quot;injury&quot;) injury21nm &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/DoctorStudy/data/2021nonmating/2021nonmating_raw.xlsx&quot;,sheet = &quot;injury&quot;) injury22nm &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/DoctorStudy/data/2022nonmating/2022nonmating_raw.xlsx&quot;,sheet = &quot;injury&quot;) ## 結合 injury &lt;- bind_rows(injury18,injury19,injury20,injury21,injury19nm,injury21nm,injury22nm) %&gt;% pivot_longer(Kur:Har, names_to = &quot;femaleID&quot;, values_to = &quot;injury&quot;) %&gt;% mutate(injury01 = ifelse(injury &gt;= 1, 1, 0)) %&gt;% mutate(injury02 = ifelse(injury &gt;= 2, 1, 0)) %&gt;% mutate(date = as_date(date)) メスが確認できた時間や発情状態のデータと結合し、観察時間が300分以上のデータのみを抽出する。 injury %&gt;% left_join(female_dur, by = c(&quot;date&quot;, &quot;femaleID&quot;)) %&gt;% filter(dur &gt;= 300) %&gt;% left_join(female_all %&gt;% dplyr::select(date, femaleID, rs2), by = c(&quot;date&quot;,&quot;femaleID&quot;)) %&gt;% replace_na(list(rs2 = 0)) %&gt;% mutate(cat = ifelse(rs2 == &quot;1&quot;,&quot;est&quot;, ifelse(str_detect(study_period, &quot;nm&quot;),&quot;nm&quot;, &quot;nonest&quot;))) -&gt; injury_fin メスの発情状態cat(交尾期発情メスest、交尾期費発情nonest、非交尾期nm)によって怪我をした日数割合を算出する。なお、分析には少なくとも5日以上その状態が観察できた場合のみを用いる。 injury_fin %&gt;% group_by(cat, femaleID, study_period) %&gt;% summarise(N = n(), no_inj = sum(injury01, na.rm = TRUE)) %&gt;% ## 5日以上観察できた状態のみ filter(N &gt;= 5) %&gt;% ungroup() -&gt; injury_long データは以下の通り。 datatable(injury_long, options = list(scrollX = 20)) 3.1.2.2 分析 3.1.2.2.1 モデリング それでは、モデリングを行う。モデルの概要は以下の通り。 事前分布には弱情報事前分布を用いた。 分布: 二項分布 リンク関数: ロジット関数 応答変数: 怪我をした日数割合(no_inj/N) 説明変数: メスの発情状態cat(交尾期・発情est、交尾期・非発情nonest、非交尾期nm) ランダム切片: メスID(femaleID)、調査期間(study_period) m_injcomp &lt;- brm(no_inj|trials(N) ~ cat + (1|femaleID) + (1|study_period), family = binomial, iter = 5000, warmup = 2500, seed = 13, prior = c(prior(student_t(4,0,10), class = &quot;b&quot;), prior(student_t(4,0,10), class = &quot;Intercept&quot;), prior(student_t(3,0,4), class = &quot;sd&quot;)), control=list(adapt_delta = 0.9999, max_treedepth = 22), backend = &quot;cmdstanr&quot;, data = injury_long, file = &quot;model/m_injcomp.rds&quot;) 3.1.2.2.1.1 モデルチェック DHARMaパッケージ及び、そのヘルパーパッケージであるDHARMa.helpersパッケージを用いてモデルチェックを行う。 分布から大きく外れていることはなく、過分散や外れ値の問題もないよう。 plotQQunif(check_injcomp) ゼロ過剰の問題もなかった。 testZeroInflation(check_injcomp) ## ## DHARMa zero-inflation test via comparison to expected zeros with ## simulation under H0 = fitted model ## ## data: simulationOutput ## ratioObsSim = 1.1184, p-value = 0.302 ## alternative hypothesis: two.sided 3.1.2.2.1.2 結果の確認 モデルの結果は以下の通り。Rhatはすべて1.01以下であり、収束の問題はないと思われる。有向サンプルサイズにも大きな問題はない。 model_parameters(m_injcomp) 多重比較の結果は以下の通り。怪我日数割合は有意に交尾期・発情 &gt; 交尾期・非発情・非交尾期。しかし、交尾期・非発情と非交尾期の間に有意に差はなかった。これは、非交尾期にも山椒などの棘がある植物を食べた際にできた小さな怪我が結構あったため? あるいは、交尾期のデータに発情メスがいなかった日も含まれているため？ estimate_contrasts(m_injcomp, contrast = &quot;cat&quot;, ci = 0.95) 確信区間を90%にすると、非交尾期と交尾期・非発情の差の確信区間は0を含まない。 estimate_contrasts(m_injcomp, contrast = &quot;cat&quot;, ci = 0.9) 3.1.2.2.1.3 結果の図示 結果を図示する。 mean_injury &lt;- estimate_means(m_injcomp, at = &quot;cat&quot;) %&gt;% data.frame() injury_long %&gt;% mutate(cat = fct_relevel(cat,&quot;nm&quot;,&quot;nonest&quot;,&quot;est&quot;)) %&gt;% ggplot(aes(x = cat, y = no_inj/N)) + geom_violin(scale = &quot;width&quot;, fill = &quot;grey65&quot;, color = &quot;white&quot;, bw = 0.043)+ geom_boxplot(width = 0.4, size = 0.7, outlier.alpha = 0, fill = &quot;grey42&quot;) + geom_signif(comparisons = list(c(&quot;nm&quot;,&quot;nonest&quot;)), y_position = 0.2, annotation = &quot;†&quot;) + geom_signif(comparisons = list(c(&quot;nonest&quot;,&quot;est&quot;)), y_position = 0.58, annotation = &quot;***&quot;) + geom_signif(comparisons = list(c(&quot;nm&quot;,&quot;est&quot;)), y_position = 0.63, annotation = &quot;***&quot;) + geom_pointrange(data = mean_injury, aes(y = Probability, ymin = CI_low, ymax = CI_high), color = &quot;white&quot;, size = 0.3)+ geom_errorbar(data = mean_injury, aes(y = Probability, ymin = CI_low, ymax = CI_high), width = 0.1, linewidth = 0.8, color = &quot;white&quot;)+ scale_y_continuous(breaks = seq(0,0.6,0.1)) + theme_bw(base_size = 15)+ labs(x = &quot;&quot;, y = &quot;怪\\n我\\n日\\n数\\n割\\n合\\n(回/日)&quot;) + scale_x_discrete(labels = c(&quot;非交尾期&quot;, &quot;交尾期\\n(非発情)&quot;,&quot;交尾期\\n(発情)&quot;))+ theme(axis.title.y = element_text(angle = 0, vjust = 0.5, family = &quot;Yu Mincho&quot;), axis.text.x = element_text(family = &quot;Yu Mincho&quot;), axis.text.y = element_text(family = &quot;Times New Roman&quot;, size = 18)) -&gt; p_injcomp # ggsave(&quot;figure/p_injcomp.png&quot;, p_injcomp, width = 140, height = 120, units = &quot;mm&quot;, dpi = 600) 結果は以下のようになる(図3.2)。 図3.2: 季節ごとの被攻撃頻度 3.2 交尾期内での被攻撃頻度と怪我の関連 交尾期に着目し、メスの被攻撃頻度と怪我の有無の関連を調べる。 3.2.1 データの読み込み・加工 各観察日に確認された各メスへのオスの攻撃頻度(全生起サンプリング)を計算する。群れオスと群れ外オスを分けて算出する。 まず、攻撃のrawデータを読み込む。 agg18 &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/data/2018mating/2018mating_raw.xlsx&quot;, sheet = &quot;agg_MF&quot;) agg19 &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/data/2019mating/2019mating_raw.xlsx&quot;, sheet = &quot;agg_MF&quot;) agg20 &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/DoctorStudy/data/2020mating/2020mating_raw.xlsx&quot;, sheet = &quot;agg_MF&quot;) agg21 &lt;- read_excel(&quot;C:/Users/Tsubasa Yamaguchi/Desktop/Study/DoctorStudy/data/2021mating/2021mating_raw.xlsx&quot;, sheet = &quot;agg_MF&quot;) ## 結合 bind_rows(agg18, agg19, agg20, agg21) %&gt;% dplyr::select(date, type, type_no, aggressor, victim:victim3) %&gt;% mutate(date = as_date(date)) %&gt;% pivot_longer(cols = victim:victim3, names_to = &quot;victim&quot;, values_to = &quot;femaleID&quot;) %&gt;% drop_na(femaleID) %&gt;% dplyr::select(-victim) %&gt;% mutate(aggressor = str_replace(aggressor,&quot;\\\\?&quot;,&quot;&quot;)) %&gt;% mutate(study_period = str_c(&quot;m&quot;,str_sub(year(date),3,4)))-&gt; aggression_all データは以下の通り。 datatable(aggression_all) 各メスごとに被攻撃頻度を算出する。各調査期間に6歳以上だったメスを対象とする。 各年のオスの情報についてデータフレームを作成する。 ## 対象のオス bind_rows(data.frame(study_period = &quot;m18&quot;, maleID = c(&quot;TY&quot;,&quot;IT&quot;,&quot;LK&quot;,&quot;KR&quot;,&quot;EG&quot;), ntm = c(0,0,0,0,1)), data.frame(study_period = &quot;m19&quot;, maleID = c(&quot;TY&quot;,&quot;IT&quot;,&quot;LK&quot;,&quot;KR&quot;,&quot;TM&quot;,&quot;KM&quot;,&quot;TG&quot;,&quot;EG&quot;,&quot;SH&quot;,&quot;JN&quot;,&quot;RU&quot;,&quot;KY&quot;,&quot;RY&quot;), ntm = c(0,0,0,0,0,1,1,1,1,1,1,1,1)), data.frame(study_period = &quot;m20&quot;, maleID = c(&quot;TY&quot;,&quot;IT&quot;,&quot;KR&quot;,&quot;KM&quot;,&quot;TG&quot;,&quot;EG&quot;,&quot;SH&quot;,&quot;RU&quot;,&quot;RY&quot;,&quot;HG&quot;,&quot;FU&quot;,&quot;KY&quot;), ntm = c(0,0,0,1,1,1,1,1,1,1,1,1)), data.frame(study_period = &quot;m21&quot;, maleID = c(&quot;TY&quot;,&quot;KR&quot;,&quot;KM&quot;,&quot;TG&quot;,&quot;EG&quot;,&quot;SH&quot;,&quot;JN&quot;,&quot;RU&quot;,&quot;KY&quot;,&quot;HT&quot;,&quot;RY&quot;), ntm = c(0,0,0,1,1,1,1,1,1,1,1))) -&gt; males 攻撃データに攻撃したオスと攻撃されたメスの情報を追加する。 aggression_all %&gt;% left_join(att, by = c(&quot;femaleID&quot;,&quot;study_period&quot;)) %&gt;% left_join(males, by = c(&quot;aggressor&quot; = &quot;maleID&quot;,&quot;study_period&quot;)) %&gt;% filter(age &gt;= 6) -&gt; aggression_all_b データを基に、それぞれのメスが各観察日に群れオス・群れ外オスそれぞれから攻撃された頻度を求める。 aggression_all_b %&gt;% filter(!is.na(ntm)) %&gt;% filter(type_no &gt;= 1) %&gt;% group_by(date, femaleID, ntm) %&gt;% summarise(no_agg = n()) %&gt;% ungroup() %&gt;% pivot_wider(names_from = ntm, values_from = no_agg) %&gt;% rename(agg_tm = `0`, agg_ntm = `1`) -&gt; agg_female_ntm 分析には少なくとも300分以上確認出来た個体のデータのみを用いる。攻撃データをメスの怪我の状況や確認時間長などが載っているデータフレーム(injury_fin)に結合する。 injury_fin %&gt;% left_join(agg_female_ntm, by = c(&quot;date&quot;,&quot;femaleID&quot;)) %&gt;% ## 交尾期データのみ filter(!str_detect(study_period,&quot;nm&quot;)) %&gt;% filter(dur &gt;= 300) %&gt;% ## 各観察日の群れ追跡時間を結合 left_join(base_all %&gt;% dplyr::select(date, duration)) %&gt;% ## NAになっているところを0で埋める replace_na(list(agg_tm = 0, agg_ntm = 0)) %&gt;% ## 被攻撃頻度を算出 mutate(rate_agg_tm = agg_tm*60/duration, rate_agg_ntm = agg_ntm*60/duration, rate_agg_tm2 = agg_tm*60/dur, rate_agg_ntm2 = agg_ntm*60/dur) -&gt; agg_injury_ntm 3.2.2 分析1 (群れオス・群れ外オスを区別) 3.2.2.1 モデリング それでは、モデリングを行う。モデルの詳細は以下のとおりである。 事前分布には弱情報事前分布を用いた。 分布: ベルヌーイ分布 リンク関数: ロジット関数 応答変数: 怪我が確認されたか否か(injury01) 説明変数: 群れオスからの攻撃頻度(rate_agg_tm)、群れ外オスからの攻撃頻度(rate_agg_ntm`)、メスの発情の有無(rs2)、調査期間(study_period`) ランダム切片: メスID(femaleID) ## 被攻撃頻度を群れ追跡時間から算出 m_agginj &lt;- brm(injury01 ~ rate_agg_tm + rate_agg_ntm + rs2 + study_period + (1|femaleID), family = bernoulli, iter = 5000, warmup = 2500, seed = 13, prior = c(prior(student_t(4,0,10), class = &quot;b&quot;), prior(student_t(4,0,10), class = &quot;Intercept&quot;), prior(student_t(4,0,10), class = &quot;sd&quot;)), control=list(adapt_delta = 0.9999, max_treedepth = 20), backend = &quot;cmdstanr&quot;, data = agg_injury_ntm, file = &quot;model/m_agginj.rds&quot;) ## 被攻撃頻度を各個体を確認した時刻から群れ追跡終了時刻までの時間で算出 m_agginj2 &lt;- brm(injury01 ~ rate_agg_tm2 + rate_agg_ntm2 + rs2 + study_period + (1|femaleID), family = bernoulli, iter = 5000, warmup = 2500, seed = 13, prior = c(prior(student_t(4,0,10), class = &quot;b&quot;), prior(student_t(4,0,10), class = &quot;Intercept&quot;), prior(student_t(4,0,10), class = &quot;sd&quot;)), control=list(adapt_delta = 0.9999, max_treedepth = 20), backend = &quot;cmdstanr&quot;, data = agg_injury_ntm, file = &quot;model/m_agginj2.rds&quot;) 3.2.2.1.0.1 モデルチェック DHARMaパッケージ及び、そのヘルパーパッケージであるDHARMa.helpersパッケージを用いてモデルチェックを行う。 いずれのモデルも、分布から大きく外れていることはなく、過分散や外れ値の問題もないよう。 plotQQunif(check_agginj) plotQQunif(check_agginj2) 3.2.2.1.0.2 結果の確認 モデルの結果は以下の通り。Rhatはすべて1.01以下であり、収束の問題はないと思われる。有向サンプルサイズにも大きな問題はない。 いずれのモデルでも、群れオス・群れ外オスの攻撃いずれもが怪我と有意に関連。 model_parameters(m_agginj) model_parameters(m_agginj2) 3.2.2.1.1 結果の作図 群れオス nd_agginj_tm &lt;- crossing(rate_agg_tm = seq(0,2,length.out =100), rate_agg_ntm = mean(agg_injury_ntm$rate_agg_ntm), study_period = c(&quot;m18&quot;,&quot;m19&quot;,&quot;m20&quot;,&quot;m21&quot;), rs2 = c(0,1)) fit_agginj_tm &lt;- fitted(m_agginj, newdata = nd_agginj_tm, re_formula = NA) %&gt;% bind_cols(nd_agginj_tm) agg_injury_ntm %&gt;% ggplot(aes(x = rate_agg_tm, y = injury01, color = study_period))+ geom_point(shape = &quot;|&quot;, size = 3)+ geom_line(data = fit_agginj_tm, aes(y = Estimate, linetype = as.factor(rs2)), size = 0.7)+ theme_bw(base_size = 14)+ scale_y_continuous(breaks = seq(0,1,by = 0.2)) + labs(x = &quot;群れオスからの攻撃頻度&quot;, y = &quot;怪\\n我\\n日\\n数\\n割\\n合\\n(回/日)&quot;, color = &quot;調査期間&quot;, linetype = &quot;発情の有無&quot;) + scale_color_nejm()+ theme(axis.title.y = element_text(angle = 0, vjust = 0.5, family = &quot;Yu Mincho&quot;), axis.title.x = element_text(family = &quot;Yu Mincho&quot;), axis.text = element_text(family = &quot;Times New Roman&quot;, size = 13), legend.position = &quot;none&quot;, legend.title = element_text(family = &quot;Yu Mincho&quot;), aspect.ratio = 1) -&gt; p_agginj_tm 群れ外オス nd_agginj_ntm &lt;- crossing(rate_agg_ntm = seq(0,1,length.out =100), rate_agg_tm = mean(agg_injury_ntm$rate_agg_tm), study_period = c(&quot;m18&quot;,&quot;m19&quot;,&quot;m20&quot;,&quot;m21&quot;), rs2 = c(0,1)) fit_agginj_ntm &lt;- fitted(m_agginj, newdata = nd_agginj_ntm, re_formula = NA) %&gt;% bind_cols(nd_agginj_ntm) agg_injury_ntm %&gt;% ggplot(aes(x = rate_agg_ntm, y = injury01, color = study_period))+ geom_point(shape = &quot;|&quot;, size = 3)+ geom_line(data = fit_agginj_ntm, aes(y = Estimate, linetype = as.factor(rs2)), size = 0.7)+ theme_bw(base_size = 14)+ scale_y_continuous(breaks = seq(0,1,by = 0.2)) + labs(x = &quot;群れ外オスからの攻撃頻度&quot;, y = &quot;怪\\n我\\n日\\n数\\n割\\n合\\n(回/日)&quot;, color = &quot;調査期間&quot;, linetype = &quot;発情の有無&quot;) + scale_color_nejm()+ coord_cartesian(xlim = c(0,1.02))+ scale_x_continuous(breaks = seq(0,1,by=0.2))+ theme(axis.title.y = element_text(angle = 0, vjust = 0.5, family = &quot;Yu Mincho&quot;), axis.title.x = element_text(family = &quot;Yu Mincho&quot;), axis.text = element_text(family = &quot;Times New Roman&quot;, size = 13), legend.title = element_text(family = &quot;Yu Mincho&quot;), aspect.ratio = 1) -&gt; p_agginj_ntm p_agginj &lt;- p_agginj_tm + p_agginj_ntm # ggsave(&quot;figure/p_agginj.png&quot;, p_agginj, width = 230, height = 120, units = &quot;mm&quot;, dpi = 600) 結果は以下のようになる(図3.3)。 図3.3: 被攻撃頻度と怪我の関連 3.2.3 分析2 (群れオス・群れ外オスを区別しない) 3.2.3.1 データの加工 オスの属性を問わず、それぞれのメスが各観察日にオスから攻撃された頻度を求め、怪我のデータと結合する。 aggression_all_b %&gt;% filter(type_no &gt;= 1) %&gt;% group_by(date, femaleID) %&gt;% summarise(no_agg = n()) %&gt;% ungroup() -&gt; agg_female_all 分析には少なくとも300分以上確認出来た個体のデータのみを用いる。攻撃データをメスの怪我の状況や確認時間長などが載っているデータフレーム(injury_fin)に結合する。 injury_fin %&gt;% left_join(agg_female_all, by = c(&quot;date&quot;,&quot;femaleID&quot;)) %&gt;% ## 交尾期データのみ filter(!str_detect(study_period,&quot;nm&quot;)) %&gt;% filter(dur &gt;= 300) %&gt;% ## 各観察日の群れ追跡時間を結合 left_join(base_all %&gt;% dplyr::select(date, duration)) %&gt;% ## NAになっているところを0で埋める replace_na(list(no_agg = 0)) %&gt;% ## 被攻撃頻度を算出 mutate(rate_agg = no_agg*60/duration, rate_agg2 = no_agg*60/dur) -&gt; agg_injury_all 3.2.3.2 モデリング それでは、モデリングを行う。モデルの詳細は以下のとおりである。 事前分布には弱情報事前分布を用いた。 分布: ベルヌーイ分布 リンク関数: ロジット関数 応答変数: 怪我が確認されたか否か(injury01) 説明変数: オスからの攻撃頻度(rate_agg``)、メスの発情の有無(rs2)、攻撃頻度と発情の有無の交互作用、調査期間(study_period`) ランダム切片: メスID(femaleID) ## 被攻撃頻度を群れ追跡時間から算出 m_agginj_all &lt;- brm(injury01 ~ rate_agg + rs2 + rate_agg:rs2 + study_period + (1|femaleID), family = bernoulli, iter = 5000, warmup = 2500, seed = 13, prior = c(prior(student_t(4,0,10), class = &quot;b&quot;), prior(student_t(4,0,10), class = &quot;Intercept&quot;), prior(student_t(4,0,10), class = &quot;sd&quot;)), control=list(adapt_delta = 0.9999, max_treedepth = 20), backend = &quot;cmdstanr&quot;, data = agg_injury_all, file = &quot;model/m_agginj_all.rds&quot;) ## 被攻撃頻度を各個体を確認した時刻から群れ追跡終了時刻までの時間で算出 m_agginj_all2 &lt;- brm(injury01 ~ rate_agg2 + rs2 + rate_agg2:rs2 + study_period + (1|femaleID), family = bernoulli, iter = 5000, warmup = 2500, seed = 13, prior = c(prior(student_t(4,0,10), class = &quot;b&quot;), prior(student_t(4,0,10), class = &quot;Intercept&quot;), prior(student_t(4,0,10), class = &quot;sd&quot;)), control=list(adapt_delta = 0.9999, max_treedepth = 20), backend = &quot;cmdstanr&quot;, data = agg_injury_all, file = &quot;model/m_agginj_all2.rds&quot;) 3.2.3.2.0.1 モデルチェック DHARMaパッケージ及び、そのヘルパーパッケージであるDHARMa.helpersパッケージを用いてモデルチェックを行う。 いずれのモデルも、分布から大きく外れていることはなく、過分散や外れ値の問題もないよう。 plotQQunif(check_agginj_all) plotQQunif(check_agginj_all2) 3.2.3.2.0.2 結果の確認 1つ目のモデル モデルの結果は以下の通り。Rhatはすべて1.01以下であり、収束の問題はないと思われる。有向サンプルサイズにも大きな問題はない。 model_parameters(m_agginj_all) 交互作用項を含む結果を確認する。発情メス、非発情メスのいずれについても「オスからの攻撃が多い日ほど有意に怪我をする確率が高くなっていた。 estimate_slopes(m_agginj_all, trend = &quot;rate_agg&quot;, at = &quot;rs2 = c(0,1)&quot;) 2つ目のモデル こちらも結果は変わらず。 model_parameters(m_agginj_all2) estimate_slopes(m_agginj_all2, trend = &quot;rate_agg2&quot;, at = &quot;rs2 = c(0,1)&quot;) 3.2.3.2.1 結果の作図 nd_agginj_all &lt;- crossing(rate_agg = seq(0,2,length.out =100), study_period = c(&quot;m18&quot;,&quot;m19&quot;,&quot;m20&quot;,&quot;m21&quot;), rs2 = c(0,1)) fit_agginj_all &lt;- fitted(m_agginj_all, newdata = nd_agginj_all, re_formula = NA) %&gt;% bind_cols(nd_agginj_all) agg_injury_all %&gt;% ggplot(aes(x = rate_agg, y = injury01, color = study_period))+ geom_point(shape = &quot;|&quot;, size = 3)+ geom_line(data = fit_agginj_all, aes(y = Estimate, linetype = as.factor(rs2)), linewidth = 0.7)+ theme_bw(base_size = 14)+ scale_y_continuous(breaks = seq(0,1,by = 0.2)) + labs(x = &quot;オスからの攻撃頻度&quot;, y = &quot;怪\\n我\\n日\\n数\\n割\\n合\\n(回/日)&quot;, color = &quot;調査期間&quot;, linetype = &quot;発情の有無&quot;) + scale_color_nejm()+ theme(axis.title.y = element_text(angle = 0, vjust = 0.5, family = &quot;Yu Mincho&quot;), axis.title.x = element_text(family = &quot;Yu Mincho&quot;), axis.text = element_text(family = &quot;Times New Roman&quot;, size = 13), legend.title = element_text(family = &quot;Yu Mincho&quot;), aspect.ratio = 1) -&gt; p_agginj_all #ggsave(&quot;figure/p_agginj_all.png&quot;, p_agginj_all, width = 240, height = 120, units = &quot;mm&quot;, dpi = 600) 結果は以下のようになる(図3.4)。 図3.4: 被攻撃頻度と怪我の関連 "],["RGsuc.html", "4 休息は何分連続で行われる? 4.1 データの加工 4.2 分析", " 4 休息は何分連続で行われる? ニホンザルは、移動の間に数十秒程度の短い休息をとることがよくある。こうした短時間の休息を統計的に除くことはできるだろうか？ ここでは、ゼロ過剰モデルを用いることで一時的な休息とそれ以外の休息を区別できるのかを検討する。 4.1 データの加工 個体追跡データから、地上での休息が何回連続で起こっているのかを計算する。 focal_raw %&gt;% mutate(RG = ifelse(activity %in% c(&quot;R&quot;,&quot;G&quot;) &amp; T_G == &quot;G&quot;,1,0)) %&gt;% group_by(no_focal, date, study_period, subject) %&gt;% summarise(N = rle(RG)$lengths, RG = rle(RG)$values) %&gt;% filter(RG == &quot;1&quot;) %&gt;% mutate(N_minus = N-1) %&gt;% ungroup()-&gt; N_suc 連続した回数ごとの度数を示したのが以下の図である(図4.1)。 N_suc %&gt;% group_by(N) %&gt;% summarise(num = n()) %&gt;% ggplot(aes(x = N, y = num))+ geom_col()+ scale_x_continuous(breaks = seq(0,121,1)) 図4.1: 地上での休息が何回連続で続いたか 4.2 分析 4.2.1 モデリング 以下では、一時的な休息がそうでない休息に混ざっていると仮定するゼロ過剰モデルと、そうではないモデルをデータに適用する。なお、ゼロ過剰モデルを適用するため、休息の連続回数から1を引く。 いずれのモデルにも負の二項分布を適用した。ゼロ過剰モデルについては、こちらを参照。 ## ゼロ過剰モデル m_rgsuc_zi &lt;- brm(bf(N_minus ~ study_period + (1|subject), zi ~ 1 + (1|subject)), family = zero_inflated_negbinomial(), iter = 5000, warmup = 2500, seed = 13, control=list(adapt_delta = 0.999, max_treedepth = 15), backend = &quot;cmdstanr&quot;, data = N_suc, file = &quot;model/m_rgsuc_zi.rds&quot;) m_rgsuc_nb &lt;- brm(N_minus ~ study_period + (1|subject), family = negbinomial, iter = 5000, warmup = 2500, seed = 13, control=list(adapt_delta = 0.999, max_treedepth = 15), backend = &quot;cmdstanr&quot;, data = N_suc, file = &quot;model/m_rgsuc_nb.rds&quot;) 4.2.1.1 モデルチェック 負の二項分布でもゼロ過剰にはなっていなかった。つまり、ゼロ過剰モデルを仮定しなくてもデータの0の多さを説明できているということである。 testZeroInflation(check_nb) ## ## DHARMa zero-inflation test via comparison to expected zeros with ## simulation under H0 = fitted model ## ## data: simulationOutput ## ratioObsSim = 0.98146, p-value = 0.528 ## alternative hypothesis: two.sided 4.2.1.2 結果の確認 ゼロ過剰モデル 推定されたゼロ過剰の切片は-4.97である。これは、0.01でしか「偽物の」ゼロが含まれていないことを示している。 model_parameters(m_rgsuc_zi) 負の二項分布モデル model_parameters(m_rgsuc_nb) 4.2.2 モデル比較 それでは、どちらのモデルの予測性がより優れているかをモデル比較で検討する。モデル比較にはWAICを用いている。 loo_rgsuc_zi &lt;- add_criterion(m_rgsuc_zi, criterion = &quot;waic&quot;) loo_rgsuc_nb &lt;- add_criterion(m_rgsuc_nb, criterion = &quot;waic&quot;) loo_comp &lt;- loo_compare(loo_rgsuc_zi, loo_rgsuc_nb, criterion = &quot;waic&quot;) モデル比較の観点からも、ゼロ過剰モデルよりも負の二項分布モデルの方が予測がうまくできることが分かった。 print(loo_comp, simplify = F) ## elpd_diff se_diff elpd_waic se_elpd_waic p_waic se_p_waic waic ## loo_rgsuc_nb 0.0 0.0 -6253.1 90.3 14.7 1.4 12506.2 ## loo_rgsuc_zi -1.0 0.5 -6254.1 90.3 15.9 1.4 12508.3 ## se_waic ## loo_rgsuc_nb 180.5 ## loo_rgsuc_zi 180.5 4.2.3 モデルからの予測値と実データの比較。 set.seed(123) coef(m_rgsuc_zi) %&gt;% data.frame() %&gt;% select(1,5,9,13,17) %&gt;% rename(In = 1, ziIn = 2, m19 = 3, m20 = 4, m21 = 5) %&gt;% bind_cols(data.frame(m18 = rep(0,18))) %&gt;% rownames_to_column(var = &quot;subject&quot;) %&gt;% pivot_longer(m19:m18, values_to = &quot;coef&quot;, names_to = &quot;study_period&quot;) -&gt; coef_zi N_suc %&gt;% select(subject, study_period) %&gt;% left_join(coef_zi, by = c(&quot;subject&quot;, &quot;study_period&quot;)) %&gt;% mutate(prob = inv_logit_scaled(ziIn)) %&gt;% mutate(onezero = ifelse(rbernoulli(nrow(N_suc),prob),0,1)) %&gt;% mutate(mu = exp(In + coef)) %&gt;% mutate(N = onezero*rnbinom(nrow(N_suc), mu = exp(In + coef),size = posterior_summary(m_rgsuc_zi)[8,1])) %&gt;% ggplot(aes(x = N ))+ geom_histogram(binwidth = 1, fill = &quot;red3&quot;, alpha = 0.3)+ geom_col(data = N_suc %&gt;% group_by(N_minus) %&gt;% summarise(num = n()), aes(x = N_minus, y = num), alpha = 0.7) + theme_bw()+ scale_y_continuous(expand= c(0.01,0))+ theme(aspect.ratio = 0.8)+ labs(title = &quot;zero-inflated model&quot;, x = &quot;N-1&quot;) -&gt; p_zi set.seed(123) coef(m_rgsuc_nb) %&gt;% data.frame() %&gt;% select(1,5,9,13) %&gt;% rename(In = 1, m19 = 2, m20 = 3, m21 = 4) %&gt;% bind_cols(data.frame(m18 = rep(0,18))) %&gt;% rownames_to_column(var = &quot;subject&quot;) %&gt;% pivot_longer(m19:m18, values_to = &quot;coef&quot;, names_to = &quot;study_period&quot;)-&gt; coef_nb N_suc %&gt;% select(subject, study_period) %&gt;% left_join(coef_nb, by = c(&quot;subject&quot;, &quot;study_period&quot;)) %&gt;% mutate(N = rnbinom(nrow(N_suc), mu = exp(In + coef), size = posterior_summary(m_rgsuc_nb)[6,1])) %&gt;% ggplot(aes(x = N )) + geom_histogram(binwidth = 1, fill = &quot;red3&quot;, alpha = 0.3)+ geom_col(data = N_suc %&gt;% group_by(N_minus) %&gt;% summarise(num = n()), aes(x = N_minus, y = num), alpha = 0.7)+ theme_bw()+ scale_y_continuous(expand= c(0.01,0))+ theme(aspect.ratio = 0.8)+ labs(title = &quot;negative binomial model&quot;, x = &quot;N-1&quot;) -&gt; p_nb 各モデルから予測された値の分布と、実データの分布を比較したのが図4.2である。灰色バーが実データで、赤いバーがモデルから予測された値である。 グラフを見ると、ゼロ過剰モデルを用いなくてもモデルからの予測値が実データとうまくマッチしていることが分かる。つまり、このアプローチでは短時間の休息とそのほかの休息を区別することはできなかった。 p_rgsuc &lt;- p_zi + p_nb p_rgsuc 図4.2: 実データと各モデルの予測値の比較 # ggsave(&quot;figure/p_rgsuc.png&quot;, width = 220, height = 110, dpi = 600, units = &quot;mm&quot;) "],["sessioninfo.html", "実行環境", " 実行環境 sessionInfo() ## R version 4.2.2 (2022-10-31 ucrt) ## Platform: x86_64-w64-mingw32/x64 (64-bit) ## Running under: Windows 10 x64 (build 22621) ## ## Matrix products: default ## ## locale: ## [1] LC_COLLATE=Japanese_Japan.utf8 LC_CTYPE=Japanese_Japan.utf8 ## [3] LC_MONETARY=Japanese_Japan.utf8 LC_NUMERIC=C ## [5] LC_TIME=Japanese_Japan.utf8 ## ## attached base packages: ## [1] stats graphics grDevices utils datasets methods base ## ## other attached packages: ## [1] ggsignif_0.6.4 ggdist_3.3.0 ## [3] see_0.7.5.5 report_0.5.7.4 ## [5] parameters_0.20.3 performance_0.10.3 ## [7] modelbased_0.8.6.3 insight_0.19.1.4 ## [9] effectsize_0.8.3.6 datawizard_0.7.1.1 ## [11] correlation_0.8.4 bayestestR_0.13.1 ## [13] easystats_0.6.0.8 DHARMa.helpers_0.0.0.9000 ## [15] DHARMa_0.4.6 rstan_2.26.13 ## [17] StanHeaders_2.26.13 brms_2.18.0 ## [19] Rcpp_1.0.9 glmmTMB_1.1.5 ## [21] lme4_1.1-31 Matrix_1.5-1 ## [23] rmdformats_1.0.4 fontregisterer_0.3 ## [25] systemfonts_1.0.4 extrafont_0.18 ## [27] ggplotify_0.1.0 lemon_0.4.6 ## [29] ggsci_2.9 stargazer_5.2.3 ## [31] kableExtra_1.3.4 knitr_1.42 ## [33] DT_0.27 ggeffects_1.1.4 ## [35] flextable_0.9.1 patchwork_1.1.2 ## [37] dbplyr_2.2.1 readxl_1.4.1 ## [39] lubridate_1.9.0 timechange_0.1.1 ## [41] forcats_1.0.0 stringr_1.5.0 ## [43] dplyr_1.1.2 purrr_1.0.0 ## [45] readr_2.1.3 tidyr_1.2.1 ## [47] tibble_3.2.1 ggplot2_3.4.2 ## [49] tidyverse_1.3.2 ## ## loaded via a namespace (and not attached): ## [1] utf8_1.2.2 tidyselect_1.2.0 htmlwidgets_1.6.1 ## [4] grid_4.2.2 munsell_0.5.0 codetools_0.2-18 ## [7] ragg_1.2.4 miniUI_0.1.1.1 withr_2.5.0 ## [10] Brobdingnag_1.2-9 colorspace_2.0-3 highr_0.10 ## [13] uuid_1.1-0 rstudioapi_0.14 stats4_4.2.2 ## [16] officer_0.6.2 Rttf2pt1_1.3.8 bayesplot_1.10.0 ## [19] fontLiberation_0.1.0 labeling_0.4.2 emmeans_1.8.3 ## [22] farver_2.1.1 gap.datasets_0.0.5 bridgesampling_1.1-2 ## [25] coda_0.19-4 vctrs_0.6.2 generics_0.1.3 ## [28] xfun_0.36 fontquiver_0.2.1 R6_2.5.1 ## [31] markdown_1.7 cachem_1.0.6 gridGraphics_0.5-1 ## [34] assertthat_0.2.1 promises_1.2.0.1 scales_1.2.1 ## [37] googlesheets4_1.0.1 gtable_0.3.3 processx_3.8.0 ## [40] rlang_1.1.1 splines_4.2.2 extrafontdb_1.0 ## [43] TMB_1.9.1 gargle_1.2.1 broom_1.0.2 ## [46] checkmate_2.1.0 inline_0.3.19 yaml_2.3.7 ## [49] reshape2_1.4.4 abind_1.4-5 modelr_0.1.10 ## [52] threejs_0.3.3 crosstalk_1.2.0 backports_1.4.1 ## [55] httpuv_1.6.7 tensorA_0.36.2 tools_4.2.2 ## [58] bookdown_0.31 ellipsis_0.3.2 jquerylib_0.1.4 ## [61] posterior_1.3.1 plyr_1.8.8 base64enc_0.1-3 ## [64] ps_1.7.2 prettyunits_1.1.1 openssl_2.0.5 ## [67] zoo_1.8-11 haven_2.5.1 fs_1.5.2 ## [70] crul_1.3 magrittr_2.0.3 data.table_1.14.6 ## [73] colourpicker_1.2.0 reprex_2.0.2 googledrive_2.0.0 ## [76] mvtnorm_1.1-3 matrixStats_0.63.0 hms_1.1.3 ## [79] shinyjs_2.1.0 mime_0.12 evaluate_0.20 ## [82] xtable_1.8-4 shinystan_2.6.0 gridExtra_2.3 ## [85] rstantools_2.2.0 compiler_4.2.2 fontBitstreamVera_0.1.1 ## [88] V8_4.2.2 crayon_1.5.2 minqa_1.2.5 ## [91] htmltools_0.5.4 later_1.3.0 tzdb_0.3.0 ## [94] RcppParallel_5.1.6 DBI_1.1.3 MASS_7.3-58.1 ## [97] boot_1.3-28 cli_3.6.0 parallel_4.2.2 ## [100] igraph_1.3.5 pkgconfig_2.0.3 numDeriv_2016.8-1.1 ## [103] xml2_1.3.3 dygraphs_1.1.1.6 svglite_2.1.1 ## [106] bslib_0.4.2 webshot_0.5.4 estimability_1.4.1 ## [109] rvest_1.0.3 yulab.utils_0.0.6 distributional_0.3.2 ## [112] callr_3.7.3 digest_0.6.31 httpcode_0.3.0 ## [115] rmarkdown_2.20 cellranger_1.1.0 gdtools_0.3.3 ## [118] gap_1.4-2 curl_4.3.3 shiny_1.7.4 ## [121] gtools_3.9.4 nloptr_2.0.3 lifecycle_1.0.3 ## [124] nlme_3.1-160 jsonlite_1.8.4 cmdstanr_0.5.3 ## [127] viridisLite_0.4.1 askpass_1.1 fansi_1.0.3 ## [130] pillar_1.9.0 lattice_0.20-45 loo_2.5.1 ## [133] fastmap_1.1.0 httr_1.4.4 pkgbuild_1.4.0 ## [136] glue_1.6.2 xts_0.12.2 zip_2.2.2 ## [139] shinythemes_1.2.0 stringi_1.7.8 sass_0.4.5 ## [142] textshaping_0.3.6 gfonts_0.2.0 References Chang, W. (2018). R graphics cookbook: Practical recipes for visualizing data. “O’Reilly Media, Inc.” Wickham, H., &amp; Grolemund, G. (2016). R for data science: Import, tidy, transform, visualize, and model data. “O’Reilly Media, Inc.” 松村優哉., 湯谷啓明., 紀ノ定保礼., &amp; 前田和. (2021). RユーザのためのRstudio[実践]入門 tidyverseによるモダンな分析フローの世界 改訂2版. 技術評論社. "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
